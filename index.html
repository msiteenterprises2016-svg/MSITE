<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MSITE Inventory ‚Äî Modern Dashboard</title>
<meta name="theme-color" content="#005fb8" />
<link rel="icon" href="msite.png?v=2.0.0" type="image/png">

<style>
  :root{
  --bg-1: linear-gradient(135deg,#004b8d,#1976d2 60%,#63a4ff);
  --card-bg:#ffffff;
  --accent:#005fb8;           
  --accent-2:#00509e;          /* slightly darker for buttons only */
  --text-primary:#1a1a1a;      /* NEW: header/body text */
  --muted:#5c6b7b;
  --border:#e3ebf5;
  --danger:#e53935;
  --success:#00796b;
  --glass: rgba(255,255,255,0.92);
  --radius:14px;
  --shadow-1: 0 8px 22px rgba(8,30,60,0.12);
  --shadow-2: 0 4px 12px rgba(8,30,60,0.08);
  --max-width:1150px;
  --sidebar-w:260px;
  font-synthesis:none;
    h1, h2, h3, h4, h5, h6, .page-title {
  color: var(--text-primary);
}

}

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg-1);-webkit-font-smoothing:antialiased;color:#12202b;}

  /* App grid */
  .app{min-height:100vh;display:flex;gap:22px;padding:28px;align-items:flex-start;justify-content:center;}
  .container{width:100%;max-width:var(--max-width);display:flex;gap:20px;align-items:flex-start;}

  /* Sidebar */
  .sidebar{
    width:var(--sidebar-w);background:var(--glass);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow-1);
    position:sticky;top:28px;height:calc(100vh - 56px);overflow:auto;border:1px solid rgba(255,255,255,0.32);
  }
  .brand{font-weight:800;color:var(--accent);text-align:center;padding:10px 6px;font-size:18px;margin-bottom:6px}
  .nav{list-style:none;padding:0;margin:10px 0}
  .nav button{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;color:#083049;font-weight:700;cursor:pointer}
  .nav button:hover{background:linear-gradient(90deg,rgba(2,86,163,0.06),rgba(2,86,163,0.03))}
  .nav button.active{background:linear-gradient(90deg,rgba(0,95,184,0.12),rgba(0,95,184,0.04));box-shadow:var(--shadow-2)}

  /* Main area */
  .main{
    flex:1;display:flex;flex-direction:column;gap:16px;min-width:0;
  }
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .page-title{font-size:1.3rem;font-weight:800;color:var(--accent-2)}
  .hamburger{display:none;background:var(--accent);color:white;border:0;padding:10px;border-radius:10px;cursor:pointer}

  /* Card */
  .card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow-2)}
  .card-lg{padding:20px;border-radius:16px}

  /* controls */
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,select{padding:10px;border:1px solid var(--border);border-radius:10px;outline:none;font-size:0.95rem;background:#fff}
  input:focus,select:focus{box-shadow:0 4px 18px rgba(0,95,184,0.06);border-color:var(--accent)}
  .btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--accent);color:white;box-shadow:0 6px 18px rgba(0,95,184,0.12)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--accent-2)}
  .btn-danger{background:var(--danger);color:white}
  .muted{color:var(--muted);font-size:0.95rem}
  .small{font-size:0.9rem;color:var(--muted)}

  /* Stock table */
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  thead th{background:linear-gradient(180deg,#f6fbff,#eef7ff);color:var(--accent-2);text-align:left;padding:12px;border-bottom:1px solid var(--border);font-weight:800}
  tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
  tbody tr:hover td{background:#fbfdff}
  .icon-btn{padding:8px;border-radius:8px;border:0;background:transparent;cursor:pointer}
  .float-add{position:sticky;bottom:18px;display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

  /* PO lines table (modern) */
  .po-table thead th{padding:12px}
  .po-table tbody td{padding:10px}
  .line-number{width:48px;text-align:center;color:var(--muted);font-weight:700}
  .subtotal{font-weight:800;text-align:right;color:#0b2b3a}

  /* summary */
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding-top:12px;gap:12px}
  .total-chip{background:#f4f9ff;border-radius:10px;padding:8px 12px;border:1px solid var(--border);font-weight:800;color:var(--accent-2)}

  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,12,20,0.45);z-index:999;visibility:hidden;opacity:0;transition:all .18s}
  .modal.show{visibility:visible;opacity:1}
  .modal-box{background:#fff;border-radius:12px;padding:18px;max-width:880px;width:94%;box-shadow:var(--shadow-1);}

  /* responsive */
  @media (max-width:980px){ .container{padding:0 8px} .sidebar{display:none} .hamburger{display:inline-block} }
  @media (max-width:640px){
    .row{flex-direction:column;align-items:stretch}
    .po-table thead{display:none}
    .po-table tbody tr{display:block;border-radius:10px;margin-bottom:10px;padding:8px;border:1px solid var(--border)}
    .po-table tbody td{display:flex;justify-content:space-between;padding:8px}
    .line-number{display:block}
  }

  /* small helpers */
  .text-right{text-align:right}
  .muted-2{color:#9aa6b3}
</style>
</head>
<body>

<div class="app">
  <div class="container">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">MSITE Inventory</div>
      <nav>
        <ul class="nav">
          <li><button id="nav-dashboard" class="active" onclick="openMenu('dashboard')">üè† Dashboard</button></li>
          <li><button id="nav-stock" onclick="openMenu('stock')">üì¶ Stock Management</button></li>
          <li><button id="nav-po" onclick="openMenu('po')">üßæ Purchase Orders</button></li>
        </ul>
      </nav>
      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <div class="small muted">Signed in: <strong>MSITE</strong></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-ghost" onclick="renderStock()">‚ü≥ Refresh Data</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="card card-lg page">
        <div style="display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px;background:#fbfeff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Total unique items</div>
            <div style="font-size:1.2rem;font-weight:800" id="summary-count">0</div>
          </div>
          <div style="flex:1;min-width:200px;background:#fbfeff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Total stock (sum qty)</div>
            <div style="font-size:1.2rem;font-weight:800" id="summary-total">0</div>
          </div>
          <div style="flex:1;min-width:200px;background:#fbfeff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Purchase orders filed</div>
            <div style="font-size:1.2rem;font-weight:800" id="summary-pos">0</div>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">
        <h3 style="margin:0 0 8px 0">Recent Purchase Orders</h3>
        <div id="recentPOsContainer" class="muted-2">Loading...</div>
      </section>

      <!-- STOCK MANAGEMENT -->
      <section id="stock" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h3 style="margin:0">Stock Management</h3>
            <div class="muted small">Add and manage products ‚Äî edits sync to Firebase.</div>
          </div>
          <div class="row">
            <input id="search" placeholder="Search items..." oninput="renderStock()" />
            <button class="btn btn-primary" onclick="showAddStockModal()">+ Add Item</button>
          </div>
        </div>

        <div style="margin-top:14px;overflow:auto">
          <table>
            <thead>
              <tr><th>Name</th><th style="width:120px">Qty</th><th style="width:120px">Unit</th><th style="width:140px">Price</th><th style="width:160px">Action</th></tr>
            </thead>
            <tbody id="stockTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- PURCHASE ORDERS -->
      <section id="po" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <h3 style="margin:0">Purchase Orders</h3>
            <div class="muted small">Create a PO and deduct stock automatically.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-ghost" onclick="renderPOList()">‚ü≥ Refresh</button>
            <button class="btn btn-primary" onclick="addPOLine()">+ Add Line</button>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="row" style="margin-bottom:8px">
            <div style="flex:1">
              <label class="small muted">PO Number</label>
              <input id="po-number" readonly>
            </div>
            <div style="flex:1">
              <label class="small muted">Date</label>
              <input id="po-date" type="date">
            </div>
            <div style="flex:2">
              <label class="small muted">School / Customer</label>
              <input id="po-customer" placeholder="School or customer name">
            </div>
          </div>

          <!-- PO Lines -->
          <div style="overflow:auto">
            <table class="po-table" id="poTable">
              <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Item</th>
                  <th style="width:92px">Qty</th>
                  <th style="width:110px">Unit</th>
                  <th style="width:140px">Price</th>
                  <th style="width:160px">Subtotal</th>
                  <th style="width:76px"> </th>
                </tr>
              </thead>
              <tbody id="poTableBody"></tbody>
            </table>
          </div>

          <div class="summary-row">
            <div class="small muted">Tip: choose items from stock ‚Äî price and unit auto-fill.</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="total-chip">Total: <span id="po-total">‚Ç±0.00</span></div>
              <button class="btn btn-primary" onclick="submitPO()">Submit & Print</button>
            </div>
          </div>
        </div>

        <div style="margin-top:14px">
          <h4 style="margin:6px 0">Existing Purchase Orders</h4>
          <div id="poListContainer" class="muted-2">Loading POs...</div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- TOAST -->
<div id="toast" style="position:fixed;bottom:22px;right:22px;background:var(--accent);color:white;padding:12px 16px;border-radius:10px;box-shadow:var(--shadow-1);opacity:0;transform:translateY(10px);transition:all .28s;z-index:9999"></div>

<!-- MODALS -->
<div id="modalAddStock" class="modal">
  <div class="modal-box">
    <h3 style="margin:0 0 8px 0;color:var(--accent)">Add / Edit Stock</h3>
    <div class="row" style="margin-bottom:8px">
      <input id="modal-stock-name" placeholder="Item name" style="flex:2">
      <input id="modal-stock-qty" type="number" placeholder="Quantity" style="flex:1" min="0">
      <input id="modal-stock-unit" placeholder="Unit" style="flex:1">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <input id="modal-stock-price" type="number" placeholder="Price" style="width:160px" step="0.01">
      <button class="btn btn-primary" onclick="saveStockFromModal()">Save</button>
      <button class="btn btn-ghost" onclick="closeAddStockModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="poViewerModal" class="modal">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0;color:var(--accent)">Purchase Order</h3>
      <div><button class="btn btn-ghost" onclick="closePOViewer()">Close</button></div>
    </div>
    <div id="poViewerContent" style="margin-top:12px"></div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn btn-primary" onclick="printLastViewedPO()">üñ® Print</button>
    </div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

<script>
/* ---------- Firebase config (unchanged) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCRaNvNt2aVsJeI51gagE3XMRG_hnDA8aY",
  authDomain: "msite-45cd2.firebaseapp.com",
  databaseURL: "https://msite-45cd2-default-rtdb.firebaseio.com/",
  projectId: "msite-45cd2",
  storageBucket: "msite-45cd2.firebasestorage.app",
  messagingSenderId: "634058871629",
  appId: "1:634058871629:web:e92190c30153f56cf41d04"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stocksRef = db.ref("stocks");
const posRef = db.ref("purchaseOrders");

/* ---------- Local state ---------- */
window.stockData = JSON.parse(localStorage.getItem("stockData") || "[]");
window.poLines = [];
let editingStockIndex = null;
let lastViewedPO = null;

function saveLocal(){ localStorage.setItem("stockData", JSON.stringify(window.stockData || [])); }

/* ---------- UI helpers ---------- */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.opacity = '1'; t.style.transform = 'translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; },2500);
}
function showModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }

/* ---------- Navigation ---------- */
function openMenu(menuId){
  document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
  document.getElementById(menuId).style.display = 'block';
  document.getElementById('pageTitle').textContent = menuId === 'dashboard' ? 'Dashboard' : (menuId==='stock' ? 'Stock Management' : 'Purchase Orders');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(menuId==='dashboard') document.getElementById('nav-dashboard').classList.add('active');
  if(menuId==='stock') document.getElementById('nav-stock').classList.add('active');
  if(menuId==='po') document.getElementById('nav-po').classList.add('active');
}

/* ---------- Stock logic ---------- */
function renderStock(){
  const tbody = document.getElementById('stockTableBody');
  const q = (document.getElementById('search')?.value || '').toLowerCase();
  tbody.innerHTML = '';
  (window.stockData||[]).filter(s=> s && s.name && s.name.toLowerCase().includes(q)).forEach((s,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escape(s.name)}</td>
      <td style="width:120px">${s.qty}</td>
      <td style="width:120px">${escape(s.unit||'')}</td>
      <td style="width:140px">‚Ç±${(parseFloat(s.price)||0).toFixed(2)}</td>
      <td style="width:160px">
        <button class="icon-btn" title="Edit" onclick="openEditStock(${i})">‚úèÔ∏è</button>
        <button class="icon-btn" title="Delete" onclick="deleteStock(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Add / Edit stock modal */
function showAddStockModal(){
  editingStockIndex = null;
  document.getElementById('modal-stock-name').value = '';
  document.getElementById('modal-stock-qty').value = '';
  document.getElementById('modal-stock-unit').value = '';
  document.getElementById('modal-stock-price').value = '';
  showModal('modalAddStock');
}
function closeAddStockModal(){ closeModal('modalAddStock'); }

function openEditStock(i){
  editingStockIndex = i;
  const s = window.stockData[i];
  document.getElementById('modal-stock-name').value = s.name || '';
  document.getElementById('modal-stock-qty').value = s.qty || 0;
  document.getElementById('modal-stock-unit').value = s.unit || '';
  document.getElementById('modal-stock-price').value = s.price || 0;
  showModal('modalAddStock');
}

function saveStockFromModal(){
  const name = (document.getElementById('modal-stock-name').value || '').trim();
  const qty = parseFloat(document.getElementById('modal-stock-qty').value) || 0;
  const unit = (document.getElementById('modal-stock-unit').value || '').trim();
  const price = parseFloat(document.getElementById('modal-stock-price').value) || 0;
  if(!name){ showToast('Enter item name'); return; }
  if(qty < 0){ showToast('Quantity invalid'); return; }
  if(price < 0){ showToast('Price invalid'); return; }

  if(editingStockIndex === null){
    const existing = window.stockData.find(x => x.name.toLowerCase() === name.toLowerCase());
    if(existing){
      existing.qty += qty;
      existing.unit = unit || existing.unit;
      existing.price = price;
    } else {
      window.stockData.push({ name, qty, unit, price });
    }
    showToast('Stock added');
  } else {
    window.stockData[editingStockIndex] = { name, qty, unit, price };
    showToast('Stock updated');
  }
  closeAddStockModal();
  saveStocksToFirebase();
}

/* Delete stock */
function deleteStock(i){
  if(!confirm('Delete this item?')) return;
  window.stockData.splice(i,1);
  saveStocksToFirebase();
  renderStock();
  refreshSummary();
}

/* Save to Firebase */
function saveStocksToFirebase(){
  const updates = {};
  (window.stockData || []).forEach((it, idx) => updates[idx] = it);
  stocksRef.update(updates).then(()=> {
    saveLocal();
    renderStock();
    renderPOList();
    refreshSummary();
  }).catch(e => console.error(e));
}

/* Firebase listener for stocks */
stocksRef.on('value', snap => {
  const val = snap.val();
  if(val){
    window.stockData = Array.isArray(val) ? val : Object.values(val || {});
    saveLocal();
    renderStock();
    refreshSummary();
  } else {
    window.stockData = JSON.parse(localStorage.getItem('stockData') || '[]');
    renderStock(); refreshSummary();
  }
});

/* ---------- Purchase Order logic ---------- */
function genPONumber(){
  const d = new Date(); const mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
  return `PO-${d.getFullYear()}${mm}${dd}-${Math.floor(Math.random()*9000)+1000}`;
}

function initPOForm(){
  document.getElementById('po-number').value = genPONumber();
  document.getElementById('po-date').value = (new Date()).toISOString().slice(0,10);
  document.getElementById('po-customer').value = '';
  window.poLines = [];
  renderPOLines();
  renderPOList();
}

function addPOLine(prefill){
  window.poLines.push(prefill || { itemName:'', qty:1, unit:'', price:0 });
  renderPOLines();
  setTimeout(()=> {
    const sel = document.querySelectorAll('#poTableBody select.item-select');
    if(sel && sel.length) sel[sel.length-1].focus();
  },120);
}
function clearPOLines(){ window.poLines = []; renderPOLines(); }
function removePOLine(i){ window.poLines.splice(i,1); renderPOLines(); }

function updatePOLine(i, field, value){
  if(!window.poLines[i]) return;
  if(field === 'qty') value = parseFloat(value) || 0;
  if(field === 'price') value = parseFloat(value) || 0;
  window.poLines[i][field] = value;
  if(field === 'itemName'){
    const st = window.stockData.find(s => s.name === value);
    if(st){ window.poLines[i].unit = st.unit || ''; window.poLines[i].price = st.price || 0; }
    else { window.poLines[i].unit = ''; }
  }
  renderPOLines();
}
function calcLineSubtotal(line){ return ((parseFloat(line.qty)||0) * (parseFloat(line.price)||0)) || 0; }
function calcPOTotal(){ return (window.poLines||[]).reduce((s,l)=> s + calcLineSubtotal(l), 0); }

function renderPOLines(){
  const tbody = document.getElementById('poTableBody'); tbody.innerHTML = '';
  if(!window.poLines.length){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;text-align:center;color:var(--muted)">No items. Click "Add Line" to start.</td></tr>`;
    document.getElementById('po-total').textContent = `‚Ç±${calcPOTotal().toFixed(2)}`;
    return;
  }
  window.poLines.forEach((line,i)=>{
    const subtotal = calcLineSubtotal(line);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="line-number">${i+1}</td>
      <td>
        <select class="item-select" onchange="updatePOLine(${i}, 'itemName', this.value)">
          <option value="">-- select product --</option>
          ${ (window.stockData||[]).map(s => `<option ${s.name===line.itemName?'selected':''} value="${escape(s.name)}">${escape(s.name)} (${s.qty} ${escape(s.unit||'')})</option>`).join('') }
        </select>
      </td>
      <td><input type="number" min="1" value="${line.qty||1}" onchange="updatePOLine(${i}, 'qty', this.value)"></td>
      <td><input value="${escape(line.unit||'')}" onchange="updatePOLine(${i}, 'unit', this.value)"></td>
      <td><input type="number" step="0.01" min="0" value="${line.price||0}" onchange="updatePOLine(${i}, 'price', this.value)"></td>
      <td class="subtotal">‚Ç±${subtotal.toFixed(2)}</td>
      <td class="text-right"><button class="btn btn-ghost" onclick="removePOLine(${i})">Remove</button></td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('po-total').textContent = `‚Ç±${calcPOTotal().toFixed(2)}`;
}

/* Submit PO: validate, push to firebase, deduct stock */
function submitPO(){
  const cust = (document.getElementById('po-customer').value || '').trim();
  const date = (document.getElementById('po-date').value || '').trim();
  const poNum = document.getElementById('po-number').value;
  if(!cust){ showToast('Enter customer/school name'); return; }
  if(!date){ showToast('Choose a date'); return; }
  if(!window.poLines.length){ showToast('Add at least one line'); return; }

  // validation
  for(const l of window.poLines){
    if(!l.itemName){ showToast('Select product on all lines'); return; }
    if(!(parseFloat(l.qty) > 0)){ showToast(`Invalid qty for ${l.itemName}`); return; }
    const st = window.stockData.find(s => s.name === l.itemName);
    if(!st){ showToast(`Item not in stock: ${l.itemName}`); return; }
    if(l.qty > st.qty){ showToast(`Not enough stock for ${l.itemName} (available ${st.qty})`); return; }
  }

  if(!confirm(`Submit PO ${poNum}? This will deduct items from stock.`)) return;

  const poObj = {
    poNumber: poNum,
    customer: cust,
    date: date,
    lines: JSON.parse(JSON.stringify(window.poLines)),
    total: calcPOTotal(),
    createdAt: Date.now()
  };

  const pushRef = posRef.push();
  pushRef.set(poObj).then(()=>{
    // deduct
    window.poLines.forEach(l=>{
      const st = window.stockData.find(s => s.name === l.itemName);
      if(st) st.qty = Math.max(0,(st.qty||0) - (l.qty||0));
    });
    saveStocksToFirebase();
    showToast('PO saved ‚úî');
    openPrintableInvoice(poObj);
    initPOForm();
    renderPOList();
  }).catch(err => {
    console.error(err);
    showToast('Error saving PO');
  });
}

/* Render PO list */
function renderPOList(){
  const container = document.getElementById('poListContainer');
  container.innerHTML = 'Loading...';
  posRef.orderByChild('createdAt').limitToLast(150).once('value').then(snap=>{
    const data = snap.val();
    if(!data){ container.innerHTML = '<div class="muted">No purchase orders yet.</div>'; refreshSummary(); return; }
    const arr = Object.keys(data).map(k=>({ id:k, ...data[k] })).sort((a,b)=> b.createdAt - a.createdAt);
    let html = `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f6fbff;color:var(--accent-2)"><th style="padding:10px">PO#</th><th>Customer</th><th>Date</th><th>Total</th><th>Action</th></tr></thead><tbody>`;
    html += arr.map(p => `<tr><td style="padding:10px">${p.poNumber}</td><td>${escape(p.customer)}</td><td>${escape(p.date)}</td><td>‚Ç±${(p.total||0).toFixed(2)}</td><td><button class="btn btn-ghost" onclick='viewPODetail(${JSON.stringify(p).replace(/'/g,"\\'")})'>View</button></td></tr>`).join('');
    html += '</tbody></table>';
    container.innerHTML = html;
    // update recent on dashboard
    const recent = arr.slice(0,6);
    document.getElementById('recentPOsContainer').innerHTML = recent.length ? `<ul style="margin:6px 0">${recent.map(r=>`<li style="margin:6px 0"><strong>${r.poNumber}</strong> ‚Äî ${escape(r.customer)} (${r.date}) ‚Ç±${(r.total||0).toFixed(2)}</li>`).join('')}</ul>` : '<div class="muted">No recent POs</div>';
    refreshSummary();
  }).catch(err => { console.error(err); container.innerHTML = '<div class="muted">Error loading POs</div>'; });
}

/* Viewer modal */
function viewPODetail(p){
  lastViewedPO = p;
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${p.poNumber}</strong> ‚Äî ${escape(p.customer)}</div><div>${escape(p.date)}</div></div>`;
  html += `<table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr style="background:#f6f8fb"><th style="padding:8px">Item</th><th style="padding:8px;text-align:right">Qty</th><th style="padding:8px">Unit</th><th style="padding:8px;text-align:right">Price</th><th style="padding:8px;text-align:right">Subtotal</th></tr></thead><tbody>`;
  html += (p.lines||[]).map(l=>`<tr><td style="padding:6px">${escape(l.itemName)}</td><td style="padding:6px;text-align:right">${l.qty}</td><td style="padding:6px">${escape(l.unit||'')}</td><td style="padding:6px;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td><td style="padding:6px;text-align:right">‚Ç±${(l.qty*l.price).toFixed(2)}</td></tr>`).join('');
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ‚Ç±${(p.total||0).toFixed(2)}</div>`;
  document.getElementById('poViewerContent').innerHTML = html;
  document.getElementById('poViewerModal').classList.add('show');
}
function closePOViewer(){ document.getElementById('poViewerModal').classList.remove('show'); }
function printLastViewedPO(){ if(!lastViewedPO){ showToast('No PO selected'); return; } openPrintableInvoice(lastViewedPO); }

/* Printable invoice (plain white professional) */
function openPrintableInvoice(p){
  const w = window.open('', '_blank');
  const dateText = p.date || new Date(p.createdAt||Date.now()).toISOString().slice(0,10);
  const rows = (p.lines||[]).map(l => `<tr>
    <td style="padding:8px;border:1px solid #ddd">${escape(l.itemName)}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">${l.qty}</td>
    <td style="padding:8px;border:1px solid #ddd">${escape(l.unit||'')}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${(l.qty*l.price).toFixed(2)}</td>
  </tr>`).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${p.poNumber}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222}table{width:100%;border-collapse:collapse;margin-top:14px}th{background:#f6f6f6;padding:8px;border:1px solid #ddd;text-align:left}td{padding:8px;border:1px solid #ddd} .right{text-align:right}</style>
    </head><body>
    <div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">MSITE Enterprises</h2><div>Purchase Order</div></div><div style="text-align:right"><div><strong>PO#:</strong> ${p.poNumber}</div><div><strong>Date:</strong> ${dateText}</div><div><strong>Customer:</strong> ${escape(p.customer)}</div></div></div>
    <table><thead><tr><th>Item</th><th style="text-align:right">Qty</th><th>Unit</th><th style="text-align:right">Price</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>${rows}</tbody></table>
    <div style="text-align:right;margin-top:12px;font-weight:800">Total: ‚Ç±${(p.total||0).toFixed(2)}</div>
    <div style="margin-top:18px;color:#666;font-size:0.9rem">Printed: ${new Date().toLocaleString()}</div>
    </body></html>`;
  w.document.write(html); w.document.close(); w.focus();
  setTimeout(()=> w.print(),300);
}

/* ---------- Summary ---------- */
function refreshSummary(){
  document.getElementById('summary-count').textContent = (window.stockData||[]).filter(Boolean).length;
  document.getElementById('summary-total').textContent = (window.stockData||[]).reduce((s,i)=> s + (parseFloat(i.qty)||0), 0);
  posRef.once('value').then(snap => {
    const val = snap.val(); document.getElementById('summary-pos').textContent = val ? Object.keys(val).length : 0;
  }).catch(()=>{});
}

/* ---------- Utilities ---------- */
function escape(s){ if(s===undefined || s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  openMenu('dashboard');
  renderStock();
  initPOForm();
  renderPOList();
  refreshSummary();
  posRef.on('value', ()=> renderPOList());
});

/* ---------- End ---------- */
</script>
</body>
</html>
