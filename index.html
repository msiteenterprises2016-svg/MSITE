<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MSITE Inventory ‚Äî Modern Dashboard</title>
<meta name="theme-color" content="#0073e6" />
<link rel="icon" href="msite.png?v=2.0.0" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<style>
  :root{
    --bg-1: linear-gradient(135deg,#f7fbff 0%, #f2f8ff 40%, #eaf6ff 100%);
    --card-bg:#f9fbfd;
    --accent:#0073e6; /* primary */
    --accent-2:#0050b3; /* dark accent for headers */
    --text-primary:#1e293b;
    --muted:#64748b;
    --border:#dce3ef;
    --danger:#ef4444;
    --success:#0d9488;
    --glass: rgba(255,255,255,0.95);
    --radius:12px;
    --shadow-1: 0 10px 30px rgba(16,24,40,0.06);
    --shadow-2: 0 6px 18px rgba(16,24,40,0.04);
    --max-width:1200px;
    --sidebar-w:260px;
    font-synthesis:none;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins', 'Segoe UI', Roboto, Arial, sans-serif;background:var(--bg-1);-webkit-font-smoothing:antialiased;color:var(--text-primary);}

  /* App grid */
  .app{min-height:100vh;display:flex;gap:24px;padding:30px;align-items:flex-start;justify-content:center;}
  .container{width:100%;max-width:var(--max-width);display:flex;gap:22px;align-items:flex-start;}

  /* Sidebar */
  .sidebar{
    width:var(--sidebar-w);background:var(--glass);border-radius:14px;padding:18px;box-shadow:var(--shadow-1);
    position:sticky;top:28px;height:calc(100vh - 56px);overflow:auto;border:1px solid var(--border);
  }
  .brand{font-weight:800;color:var(--accent);text-align:center;padding:12px 6px;font-size:18px;margin-bottom:8px; background: linear-gradient(90deg,var(--accent), var(--accent-2)); -webkit-background-clip: text; background-clip: text; color: transparent;}
  .nav{list-style:none;padding:0;margin:10px 0}
  .nav button{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--text-primary);font-weight:600;cursor:pointer}
  .nav button:hover{background:rgba(3,102,214,0.06)}
  .nav button.active{background:linear-gradient(90deg,rgba(0,115,230,0.10),rgba(0,115,230,0.04));box-shadow:var(--shadow-2)}

  /* Main area */
  .main{flex:1;display:flex;flex-direction:column;gap:16px;min-width:0;}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .page-title{font-size:1.6rem;font-weight:700;color:var(--accent-2);letter-spacing: -0.01em}
  .hamburger{display:none;background:var(--accent);color:white;border:0;padding:10px;border-radius:10px;cursor:pointer}

  /* Card */
  .card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow-2)}
  .card-lg{padding:22px;border-radius:14px}

  /* controls */
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,select,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;outline:none;font-size:0.95rem;background:white;color:var(--text-primary)}
  input::placeholder, textarea::placeholder{color:var(--muted)}
  input:focus,select:focus,textarea:focus{box-shadow:0 8px 26px rgba(3,102,214,0.06);border-color:var(--accent)}
  .btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;transition:all .16s ease}
  .btn-primary{background:var(--accent);color:white;box-shadow:0 8px 24px rgba(3,102,214,0.08)}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(3,102,214,0.12)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--accent-2)}
  .btn-ghost:hover{background:rgba(2,86,163,0.04)}
  .btn-danger{background:var(--danger);color:white}
  .muted{color:var(--muted);font-size:0.95rem}
  .small{font-size:0.9rem;color:var(--muted)}

  /* Stock table */
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  thead th{background:linear-gradient(180deg,#f6fbff,#eef7ff);color:var(--accent-2);text-align:left;padding:12px;border-bottom:1px solid var(--border);font-weight:700}
  tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text-primary)}
  tbody tr:hover td{background:#fff}
  tbody tr:nth-child(even) td{background: #fbfdff}
  .icon-btn{padding:8px;border-radius:8px;border:0;background:transparent;cursor:pointer}
  .float-add{position:sticky;bottom:18px;display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

  /* PO lines table (modern) */
  .po-table thead th{padding:12px}
  .po-table tbody td{padding:10px}
  .line-number{width:48px;text-align:center;color:var(--muted);font-weight:700}
  .subtotal{font-weight:800;text-align:right;color:var(--accent-2)}

  /* pending table tint (option 2) */
  .pending-head th{background:#eaf6ff;color:var(--accent-2);padding:12px;border-bottom:1px solid var(--border);font-weight:800}

  /* delivery tracker tint */
  .delivery-head th{background:#e8f4ff;color:var(--accent-2);padding:12px;border-bottom:1px solid var(--border);font-weight:800}

  /* summary */
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding-top:12px;gap:12px}
  .total-chip{background:#f4f9ff;border-radius:10px;padding:8px 12px;border:1px solid var(--border);font-weight:800;color:var(--accent-2)}

  /* modals & accordions */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,12,20,0.45);z-index:999;visibility:hidden;opacity:0;transition:all .18s}
  .modal.show{visibility:visible;opacity:1}
  .modal-box{background:#fff;border-radius:12px;padding:18px;max-width:880px;width:94%;box-shadow:var(--shadow-1);max-height:80vh;overflow:auto}

  .accordion{border-radius:10px;border:1px solid var(--border);overflow:hidden}
  .accordion .acc-head{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#fff}
  .accordion .acc-body{padding:12px;border-top:1px solid var(--border);background:#fbfdff}

/* responsive improvements */
@media (max-width:980px) {
  .app {
    flex-direction: column;
    padding: 12px;
  }

  .container {
    flex-direction: column;
    gap: 16px;
    max-width: 100%;
    padding: 0;
  }

  /* ‚úÖ Mobile sidebar: slides in/out and stays above everything */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 240px;
    height: 100vh;
    background: var(--glass);
    box-shadow: var(--shadow-1);
    border: 1px solid var(--border);
    border-radius: 0 12px 12px 0;
    z-index: 2000;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    pointer-events: auto;

  }

  .sidebar.show {
    transform: translateX(0);
  }

  .hamburger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: white;
    border: 0;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }

  .main {
    width: 100%;
  }
}


@media (max-width:640px) {
  .row { flex-direction: column; align-items: stretch; }
  .card { padding: 12px; }
  .topbar { flex-direction: column; align-items: flex-start; gap: 8px; }
  .po-table thead { display: none; }
  .po-table tbody tr {
    display: block;
    margin-bottom: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
  }
  .po-table tbody td {
    display: flex;
    justify-content: space-between;
    padding: 6px;
  }
}


  /* small helpers */
  .text-right{text-align:right}
  .muted-2{color:#9aa6b3}

  /* floating labels (small) */
  .form-label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:6px;font-weight:600}

  /* subtle transitions */
  input, select, textarea, .btn, .icon-btn { transition: all .12s ease-in-out }

  #po input.input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  outline: none;
  transition: 0.2s;
}
#po input.input:focus {
  border-color: var(--accent-2);
  box-shadow: 0 0 0 2px rgba(0,115,230,0.2);
}
#po table th, #po table td {
  border-bottom: 1px solid #eee;
}
#po .btn {
  border-radius: 10px;
  font-weight: 600;
}
  /* --- FIX: Make sure the hamburger menu and sidebar always stay on top --- */
.hamburger {
  position: fixed;          /* stays in place even when scrolling */
  top: 16px;                /* adjust as needed */
  left: 16px;               /* adjust as needed */
  z-index: 9999;            /* üî• ensures it's always above everything */
  background: var(--accent);
  color: white;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

.sidebar {
  z-index: 9998;            /* sidebar just under the button but above all pages */
}


</style>
</head>
<body>

<div class="app">
  <div class="container">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">MSITE Inventory</div>
      <nav>
        <ul class="nav">
          <li><button id="nav-dashboard" class="active" onclick="openMenu('dashboard')">üè† Dashboard</button></li>
          <li><button id="nav-stock" onclick="openMenu('stock')">üì¶ Stock Management</button></li>
          <li><button id="nav-po" onclick="openMenu('po')">üßæ Purchase Orders</button></li>
          <li><button id="nav-pending" onclick="openMenu('pending')">üõí Pending / To Purchase</button></li>
          <!-- NEW Delivery Tracker -->
          <li><button id="nav-delivery" onclick="openMenu('delivery')">üè´ Delivery Tracker</button></li>
        </ul>
      </nav>
      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <div class="small muted">Signed in: <strong>MSITE</strong></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-ghost" onclick="renderStock()">‚ü≥ Refresh Data</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="card card-lg page">
        <div style="display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px;background:#fff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Total unique items</div>
            <div style="font-size:1.2rem;font-weight:800;color:var(--accent-2)" id="summary-count">0</div>
          </div>
          <div style="flex:1;min-width:200px;background:#fff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Total stock (sum qty)</div>
            <div style="font-size:1.2rem;font-weight:800;color:var(--accent-2)" id="summary-total">0</div>
          </div>
          <div style="flex:1;min-width:200px;background:#fff;padding:14px;border-radius:10px;border:1px solid var(--border)">
            <div class="small muted">Purchase orders filed</div>
            <div style="font-size:1.2rem;font-weight:800;color:var(--accent-2)" id="summary-pos">0</div>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">
        <h3 style="margin:0 0 8px 0;color:var(--accent-2)">Recent Purchase Orders</h3>
        <div id="recentPOsContainer" class="muted-2">Loading...</div>
        <hr style="margin:20px 0;border:none;border-top:1px solid var(--border)">
<h3 style="color:var(--accent-2)">üìä Sales Insights</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-top:14px">
  <div class="card" style="background:#fff">
    <h4 style="margin-bottom:8px;color:var(--accent-2)">Top 5 Schools (by total purchase)</h4>
    <canvas id="topSchoolsChart" height="200"></canvas>
  </div>
  <div class="card" style="background:#fff">
    <h4 style="margin-bottom:8px;color:var(--accent-2)">Best-Selling Items</h4>
    <canvas id="bestItemsChart" height="200"></canvas>
  </div>
</div>

<!-- tables will be injected here -->
<div id="dashboard-summary-tables"></div>

      </section>

      <!-- STOCK MANAGEMENT -->
      <section id="stock" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h3 style="margin:0;color:var(--accent-2)">Stock Management</h3>
            <div class="muted small">Add and manage products ‚Äî edits sync to Firebase.</div>
          </div>
          <div class="row">
            <input id="search" placeholder="Search items..." oninput="renderStock()" />
            <button class="btn btn-primary" onclick="showAddStockModal()">+ Add Item</button>
            <button class="btn btn-ghost" onclick="printStockList()">üñ® Print Stock List</button>
          </div>
        </div>

        <div style="margin-top:14px;overflow:auto">
          <table>
            <thead>
              <tr><th>Name</th><th style="width:120px">Qty</th><th style="width:120px">Unit</th><th style="width:140px">Price</th><th style="width:160px">Action</th></tr>
            </thead>
            <tbody id="stockTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- PURCHASE ORDERS -->
    
        <section id="po" class="page" style="display:none">
  <div class="page-header">
    <h2 style="color:var(--accent-2)">üßæ Create Purchase Order</h2>
    <p class="muted-2">Record new orders and track school purchases efficiently.</p>
  </div>

  <!-- Purchase Order Info -->
  <div style="
      background:var(--glass);
      backdrop-filter:blur(12px);
      padding:20px;
      border-radius:18px;
      box-shadow:var(--shadow-1);
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
  ">
    <div>
      <label class="muted small">PO Number</label>
      <input id="poNumber" class="input" type="text" placeholder="Auto-generated" readonly style="font-weight:600;">
    </div>

    <div>
      <label class="muted small">Date</label>
      <input id="poDate" class="input" type="date" style="font-weight:600;">
    </div>

    <div>
      <label class="muted small">School / Customer</label>
      <input id="poCustomer" class="input" type="text" placeholder="Enter school name" style="font-weight:600;">
    </div>

    <div>
      <label class="muted small">Remarks</label>
      <input id="poRemarks" class="input" type="text" placeholder="Optional note or reference">
    </div>
  </div>

  <!-- Items Section -->
  <div style="
      background:#fff;
      margin-top:24px;
      padding:20px;
      border-radius:18px;
      box-shadow:var(--shadow-2);
  ">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h3 style="color:var(--accent-2)">üõçÔ∏è Order Items</h3>
      <button onclick="addPOLine()" class="btn btn-primary">+ Add Item</button>
    </div>

    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:#f6fbff;color:var(--accent-2)">
            <th style="padding:10px;text-align:left;">Item</th>
            <th style="padding:10px;text-align:center;">Qty</th>
            <th style="padding:10px;text-align:center;">Unit</th>
            <th style="padding:10px;text-align:center;">Price</th>
            <th style="padding:10px;text-align:center;">Subtotal</th>
            <th style="padding:10px;text-align:center;">Action</th>
          </tr>
        </thead>
        <tbody id="poLineTableBody">
          <!-- Dynamic rows added here -->
        </tbody>
      </table>
    </div>

    <div style="text-align:right;margin-top:12px;">
      <span class="muted">Total:</span>
      <span id="poTotal" style="font-size:1.5rem;font-weight:800;color:var(--accent-2)">‚Ç±0.00</span>
    </div>
  </div>

  <!-- Bottom Action Bar -->
  <div style="
      position:sticky;
      bottom:0;
      background:rgba(255,255,255,0.95);
      padding:12px 20px;
      border-top:1px solid #eee;
      display:flex;
      justify-content:flex-end;
      gap:12px;
      border-radius:0 0 12px 12px;
      box-shadow:var(--shadow-1);
      z-index:10;
      margin-top:24px;
  ">
    <button class="btn btn-ghost" onclick="resetPOForm()">Reset</button>
    <button class="btn btn-outline" onclick="printPO()">Print Preview</button>
    <button class="btn btn-primary" onclick="savePO()">Save PO</button>
  </div>
</section>

       

      <!-- PENDING / TO PURCHASE -->
      <section id="pending" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
          <div>
            <h3 style="margin:0;color:var(--accent-2)">Pending / To Purchase</h3>
            <div class="muted small">Items to buy or pending deliveries to schools.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="pending-filter" onchange="renderPendingList()" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="done">Done</option>
            </select>
            <button class="btn btn-primary" onclick="showPendingModal()">+ Add Pending Item</button>
          </div>
        </div>

        <div style="margin-top:12px;overflow:auto">
          <table id="pendingTable" style="width:100%;border-collapse:collapse">
            <thead class="pending-head">
              <tr>
                <th>Item</th>
                <th style="width:120px">Qty Needed</th>
                <th>Reason</th>
                <th style="width:140px">Status</th>
                <th style="width:160px">Action</th>
              </tr>
            </thead>
            <tbody id="pendingTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- DELIVERY TRACKER (NEW - grouped by school) -->
      <section id="delivery" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="min-width:260px">
            <h3 style="margin:0;color:var(--accent-2)">Delivery Tracker</h3>
            <div class="muted small">Track missing / undelivered items per school. Add multiple items at once per school.</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="delivery-search" placeholder="Search school or item..." oninput="renderDeliveryTracker()" style="padding:8px;border-radius:8px;border:1px solid var(--border)" />
            <select id="delivery-filter" onchange="renderDeliveryTracker()" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="delivered">Delivered</option>
            </select>
            <button class="btn btn-primary" onclick="showAddDeliveryModal()">+ Add Delivery Item</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div id="deliveryListContainer"></div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- TOAST -->
<div id="toast" style="position:fixed;bottom:22px;right:22px;background:var(--accent);color:white;padding:12px 16px;border-radius:10px;box-shadow:var(--shadow-1);opacity:0;transform:translateY(10px);transition:all .28s;z-index:9999"></div>

<!-- MODALS -->
<div id="modalAddStock" class="modal">
  <div class="modal-box">
    <h3 style="margin:0 0 8px 0;color:var(--accent)">Add / Edit Stock</h3>
    <div class="row" style="margin-bottom:8px">
      <div style="flex:2">
        <label class="form-label">Item name</label>
        <input id="modal-stock-name" placeholder="Item name" style="width:100%">
      </div>
      <div style="flex:1">
        <label class="form-label">Quantity</label>
        <input id="modal-stock-qty" type="number" placeholder="Quantity" min="0">
      </div>
      <div style="flex:1">
        <label class="form-label">Unit</label>
        <input id="modal-stock-unit" placeholder="Unit">
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <div style="width:160px">
        <label class="form-label">Price</label>
        <input id="modal-stock-price" type="number" placeholder="0.00" step="0.01">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-primary" onclick="saveStockFromModal()">Save</button>
        <button class="btn btn-ghost" onclick="closeAddStockModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Pending modal (add/edit) -->
<div id="modalPending" class="modal">
  <div class="modal-box">
    <h3 style="margin:0 0 8px 0;color:var(--accent)">Add / Edit Pending Item</h3>
    <div class="row" style="margin-bottom:8px">
      <div style="flex:2">
        <label class="form-label">Item name</label>
        <input id="pending-item" placeholder="Item name">
      </div>
      <div style="flex:1">
        <label class="form-label">Qty needed</label>
        <input id="pending-qty" type="number" placeholder="Qty" min="1">
      </div>
    </div>
    <label class="form-label">Reason</label>
    <textarea id="pending-reason" placeholder="Reason (e.g. out of stock or missing delivery)" style="width:100%;height:80px;border:1px solid var(--border);border-radius:8px;padding:8px"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn btn-primary" onclick="savePendingItem()">Save</button>
      <button class="btn btn-ghost" onclick="closeModal('modalPending')">Cancel</button>
    </div>
  </div>
</div>

<!-- Delivery modal (grouped by school) -->
<div id="modalDelivery" class="modal">
  <div class="modal-box" style="max-width:760px">
    <h3 style="margin:0 0 8px 0;color:var(--accent)">Add / Edit Delivery Group (School)</h3>

    <div style="margin-bottom:10px">
      <label class="form-label">School / Customer</label>
      <input id="delivery-school" placeholder="School or customer name" style="width:100%;margin-top:6px" />
    </div>

    <div id="delivery-lines-area" style="margin-bottom:8px">
      <!-- dynamic lines go here -->
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <button class="btn btn-primary" onclick="addDeliveryLine()">+ Add Item Line</button>
      <div class="muted small">Add multiple items for the same school before saving.</div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-primary" onclick="saveDeliveryGroup()">Save Group</button>
      <button class="btn btn-ghost" onclick="closeModal('modalDelivery')">Cancel</button>
    </div>
  </div>
</div>

<!-- PO Viewer modal -->
<div id="poViewerModal" class="modal">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0;color:var(--accent)">Purchase Order</h3>
      <div><button class="btn btn-ghost" onclick="closePOViewer()">Close</button></div>
    </div>
    <div id="poViewerContent" style="margin-top:12px"></div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn btn-primary" onclick="printLastViewedPO()">üñ® Print</button>
    </div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

<script>
/* ---------- Firebase config (unchanged) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCRaNvNt2aVsJeI51gagE3XMRG_hnDA8aY",
  authDomain: "msite-45cd2.firebaseapp.com",
  databaseURL: "https://msite-45cd2-default-rtdb.firebaseio.com/",
  projectId: "msite-45cd2",
  storageBucket: "msite-45cd2.firebasestorage.app",
  messagingSenderId: "634058871629",
  appId: "1:634058871629:web:e92190c30153f56cf41d04"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stocksRef = db.ref("stocks");
const posRef = db.ref("purchaseOrders");
const pendingRef = db.ref("pendingItems");
const deliveryRef = db.ref("deliveryTracker"); // new delivery tracker node

/* ---------- Local state ---------- */
window.stockData = JSON.parse(localStorage.getItem("stockData") || "[]");
window.poLines = [];
let editingStockIndex = null;
let lastViewedPO = null;

/* pending state */
let pendingItems = [];
let editingPendingIndex = null;

/* delivery state (groups) */
let deliveryGroups = []; // each group is { key, school, items: [{item,qty,reason,status,createdAt,deliveredAt}], createdAt }
let editingDeliveryKey = null;
let tempDeliveryLines = []; // used inside modal

function saveLocal(){ localStorage.setItem("stockData", JSON.stringify(window.stockData || [])); }

/* ---------- UI helpers ---------- */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.opacity = '1'; t.style.transform = 'translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; },2500);
}
function showModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }

/* ---------- Navigation ---------- */
function openMenu(menuId) {
  // Hide all pages first
  document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
  const page = document.getElementById(menuId);
  if (page) page.style.display = 'block';

  // Update page title
  const titles = {
    dashboard: 'Dashboard',
    stock: 'Stock Management',
    po: 'Purchase Orders',
    pending: 'Pending / To Purchase',
    delivery: 'Delivery Tracker'
  };
  document.getElementById('pageTitle').textContent = titles[menuId] || 'MSITE';

  // Highlight the active button
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  const activeBtn = document.getElementById('nav-' + menuId);
  if (activeBtn) activeBtn.classList.add('active');

  // ‚úÖ Close the sidebar automatically (mobile)
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.remove('show');
}



/* ---------- Stock logic ---------- */
function renderStock(){
  const tbody = document.getElementById('stockTableBody');
  const q = (document.getElementById('search')?.value || '').toLowerCase();
  tbody.innerHTML = '';
  (window.stockData||[]).filter(s=> s && s.name && s.name.toLowerCase().includes(q)).forEach((s,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escape(s.name)}</td>
      <td style="width:120px">${s.qty}</td>
      <td style="width:120px">${escape(s.unit||'')}</td>
      <td style="width:140px">‚Ç±${(parseFloat(s.price)||0).toFixed(2)}</td>
      <td style="width:160px">
        <button class="icon-btn" title="Edit" onclick="openEditStock(${i})">‚úèÔ∏è</button>
        <button class="icon-btn" title="Delete" onclick="deleteStock(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Add / Edit stock modal */
function showAddStockModal(){
  editingStockIndex = null;
  document.getElementById('modal-stock-name').value = '';
  document.getElementById('modal-stock-qty').value = '';
  document.getElementById('modal-stock-unit').value = '';
  document.getElementById('modal-stock-price').value = '';
  showModal('modalAddStock');
}
function closeAddStockModal(){ closeModal('modalAddStock'); }

/* prefill-capable openAddStock (used when auto-adding from pending/delivery) */
function openAddStockPrefill(name){
  editingStockIndex = null;
  document.getElementById('modal-stock-name').value = name || '';
  document.getElementById('modal-stock-qty').value = '';
  document.getElementById('modal-stock-unit').value = '';
  document.getElementById('modal-stock-price').value = '';
  showModal('modalAddStock');
}

function openEditStock(i){
  editingStockIndex = i;
  const s = window.stockData[i];
  document.getElementById('modal-stock-name').value = s.name || '';
  document.getElementById('modal-stock-qty').value = s.qty || 0;
  document.getElementById('modal-stock-unit').value = s.unit || '';
  document.getElementById('modal-stock-price').value = s.price || 0;
  showModal('modalAddStock');
}

function saveStockFromModal(){
  const name = (document.getElementById('modal-stock-name').value || '').trim();
  const qty = parseFloat(document.getElementById('modal-stock-qty').value) || 0;
  const unit = (document.getElementById('modal-stock-unit').value || '').trim();
  const price = parseFloat(document.getElementById('modal-stock-price').value) || 0;
  if(!name){ showToast('Enter item name'); return; }
  if(qty < 0){ showToast('Quantity invalid'); return; }
  if(price < 0){ showToast('Price invalid'); return; }

  if(editingStockIndex === null){
    const existing = window.stockData.find(x => x.name.toLowerCase() === name.toLowerCase());
    if(existing){
      existing.qty += qty;
      existing.unit = unit || existing.unit;
      existing.price = price;
    } else {
      window.stockData.push({ name, qty, unit, price });
    }
    showToast('Stock added');
  } else {
    window.stockData[editingStockIndex] = { name, qty, unit, price };
    showToast('Stock updated');
  }
  closeAddStockModal();
  saveStocksToFirebase();
}

/* Delete stock */
function deleteStock(i){
  if(!confirm('Delete this item?')) return;
  window.stockData.splice(i,1);
  saveStocksToFirebase();
  renderStock();
  refreshSummary();
}

/* Save to Firebase */
function saveStocksToFirebase(){
  const updates = {};
  (window.stockData || []).forEach((it, idx) => updates[idx] = it);
  stocksRef.update(updates).then(()=> {
    saveLocal();
    renderStock();
    renderPOList();
    refreshSummary();
    // after stock changes, check low stock to auto add pending items
    setTimeout(()=> checkLowStock(), 300);
  }).catch(e => console.error(e));
}

x/* Firebase listener for stocks */
stocksRef.on('value', snap => {
  const val = snap.val();
  if (val) {
    window.stockData = Array.isArray(val) ? val : Object.values(val || {});
    saveLocal();
    renderStock();
    refreshSummary();

    setTimeout(() => checkLowStock(), 300);
  } else {
    window.stockData = JSON.parse(localStorage.getItem('stockData') || '[]');
    renderStock();
    refreshSummary();
   
  }
});


/* ---------- Purchase Order logic (unchanged) ---------- */
function genPONumber(){
  const d = new Date(); const mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
  return `PO-${d.getFullYear()}${mm}${dd}-${Math.floor(Math.random()*9000)+1000}`;
}

function initPOForm(){
  document.getElementById('po-number').value = genPONumber();
  document.getElementById('po-date').value = (new Date()).toISOString().slice(0,10);
  document.getElementById('po-customer').value = '';
  window.poLines = [];
  renderPOLines();
  renderPOList();
}

function addPOLine(prefill){
  window.poLines.push(prefill || { itemName:'', qty:1, unit:'', price:0 });
  renderPOLines();
  setTimeout(()=> {
    const sel = document.querySelectorAll('#poTableBody select.item-select');
    if(sel && sel.length) sel[sel.length-1].focus();
  },120);
}
function clearPOLines(){ window.poLines = []; renderPOLines(); }
function removePOLine(i){ window.poLines.splice(i,1); renderPOLines(); }

 


/* ---------- Purchase Order Lines (Compact + Organized + Auto Dropdown Refresh) ---------- */

// ‚úÖ Auto-calculate subtotal and total
function calcLineSubtotal(line) {
  return ((parseFloat(line.qty) || 0) * (parseFloat(line.price) || 0)) || 0;
}

function calcPOTotal() {
  return (window.poLines || []).reduce((sum, l) => sum + calcLineSubtotal(l), 0);
}

// ‚úÖ Update a line when user changes item/qty/price
function updatePOLine(i, field, value) {
  if (!window.poLines[i]) return;
  if (field === 'qty' || field === 'price') value = parseFloat(value) || 0;
  window.poLines[i][field] = value;

  // Auto-fill from stock data
  if (field === 'itemName') {
    const stock = (window.stockData || []).find(s => s.name === value);
    if (stock) {
      window.poLines[i].unit = stock.unit || '';
      window.poLines[i].price = parseFloat(stock.price) || 0;
    } else {
      window.poLines[i].unit = '';
      window.poLines[i].price = 0;
    }
  }

  renderPOLines();
}

// ‚úÖ Render all PO item lines
function renderPOLines() {
  const tbody = document.getElementById('poLineTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // No items yet
  if (!window.poLines?.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="padding:16px;text-align:center;color:var(--muted)">
          No items added yet. Click "<strong>+ Add Item</strong>" to start.
        </td>
      </tr>`;
    document.getElementById('poTotal').textContent = '‚Ç±0.00';
    return;
  }

  // Dropdown options from stock
  const stockOptions = (window.stockData || [])
    .map(s => `<option value="${s.name}">${s.name} (${s.qty} ${s.unit || ''})</option>`)
    .join('');

  // Render each PO line
  window.poLines.forEach((line, i) => {
    const subtotal = calcLineSubtotal(line);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select onchange="updatePOLine(${i}, 'itemName', this.value)" style="width:100%;padding:6px;border-radius:8px;border:1px solid var(--border)">
          <option value="">-- Select item --</option>
          ${stockOptions.replace(`value="${line.itemName}"`, `value="${line.itemName}" selected`)}
        </select>
      </td>
      <td style="text-align:center">
        <input type="number" min="1" value="${line.qty || 1}" onchange="updatePOLine(${i}, 'qty', this.value)" style="width:80px;text-align:center">
      </td>
      <td style="text-align:center">
        <input value="${line.unit || ''}" onchange="updatePOLine(${i}, 'unit', this.value)" style="width:80px;text-align:center">
      </td>
      <td style="text-align:center">
        <input type="number" step="0.01" min="0" value="${line.price || 0}" onchange="updatePOLine(${i}, 'price', this.value)" style="width:100px;text-align:center">
      </td>
      <td style="text-align:right">‚Ç±${subtotal.toFixed(2)}</td>
      <td style="text-align:center">
        <button class="btn btn-ghost" onclick="removePOLine(${i})">üóë Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Update total
  document.getElementById('poTotal').textContent = `‚Ç±${calcPOTotal().toFixed(2)}`;
}

// ‚úÖ Refresh dropdowns when PO page opens
function openMenu(menuId) {
  document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
  const page = document.getElementById(menuId);
  if (page) page.style.display = 'block';
  if (menuId === 'po') renderPOLines(); // refresh dropdowns
}

// ‚úÖ Refresh dropdowns after stock loads
stocksRef.on('value', snap => {
  const val = snap.val();
  if (val) {
    window.stockData = Array.isArray(val) ? val : Object.values(val || {});
    saveLocal();
    renderStock();
    refreshSummary();
    renderPOLines(); // update dropdowns
    setTimeout(() => checkLowStock(), 300);
  }
});


function submitPO(){
  const cust = (document.getElementById('po-customer').value || '').trim();
  const date = (document.getElementById('po-date').value || '').trim();
  const poNum = document.getElementById('po-number').value;
  if(!cust){ showToast('Enter customer/school name'); return; }
  if(!date){ showToast('Choose a date'); return; }
  if(!window.poLines.length){ showToast('Add at least one line'); return; }

  for(const l of window.poLines){
    if(!l.itemName){ showToast('Select product on all lines'); return; }
    if(!(parseFloat(l.qty) > 0)){ showToast(`Invalid qty for ${l.itemName}`); return; }
    const st = window.stockData.find(s => s.name === l.itemName);
    if(!st){ showToast(`Item not in stock: ${l.itemName}`); return; }
    if(l.qty > st.qty){ showToast(`Not enough stock for ${l.itemName} (available ${st.qty})`); return; }
  }

  if(!confirm(`Submit PO ${poNum}? This will deduct items from stock.`)) return;

  const poObj = {
    poNumber: poNum,
    customer: cust,
    date: date,
    lines: JSON.parse(JSON.stringify(window.poLines)),
    total: calcPOTotal(),
    createdAt: Date.now()
  };

  const pushRef = posRef.push();
  pushRef.set(poObj).then(()=>{
    // deduct
    window.poLines.forEach(l=>{
      const st = window.stockData.find(s => s.name === l.itemName);
      if(st) st.qty = Math.max(0,(st.qty||0) - (l.qty||0));
    });
    saveStocksToFirebase();
    showToast('PO saved ‚úî');
    openPrintableInvoice(poObj);
    initPOForm();
    renderPOList();
  }).catch(err => {
    console.error(err);
    showToast('Error saving PO');
  });
}

/* Render PO list */
function renderPOList(){
  const container = document.getElementById('poListContainer');
  container.innerHTML = 'Loading...';
  posRef.orderByChild('createdAt').limitToLast(150).once('value').then(snap=>{
    const data = snap.val();
    if(!data){ container.innerHTML = '<div class="muted">No purchase orders yet.</div>'; refreshSummary(); return; }
    const arr = Object.keys(data).map(k=>({ id:k, ...data[k] })).sort((a,b)=> b.createdAt - a.createdAt);
    let html = `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f6fbff;color:var(--accent-2)"><th style="padding:10px">PO#</th><th>Customer</th><th>Date</th><th>Total</th><th>Action</th></tr></thead><tbody>`;
    html += arr.map(p => `<tr><td style="padding:10px">${p.poNumber}</td><td>${escape(p.customer)}</td><td>${escape(p.date)}</td><td>‚Ç±${(p.total||0).toFixed(2)}</td><td><button class="btn btn-ghost" onclick='viewPODetail(${JSON.stringify(p).replace(/'/g,"\\'")})'>View</button></td></tr>`).join('');
    html += '</tbody></table>';
    container.innerHTML = html;
    // update recent on dashboard
    const recent = arr.slice(0,6);
    document.getElementById('recentPOsContainer').innerHTML = recent.length ? `<ul style="margin:6px 0">${recent.map(r=>`<li style="margin:6px 0"><strong>${r.poNumber}</strong> ‚Äî ${escape(r.customer)} (${r.date}) ‚Ç±${(r.total||0).toFixed(2)}</li>`).join('')}</ul>` : '<div class="muted">No recent POs</div>';
    refreshSummary();
  }).catch(err => { console.error(err); container.innerHTML = '<div class="muted">Error loading POs</div>'; });
}

/* Viewer modal */
function viewPODetail(p){
  lastViewedPO = p;
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${p.poNumber}</strong> ‚Äî ${escape(p.customer)}</div><div>${escape(p.date)}</div></div>`;
  html += `<table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr style="background:#f6f8fb"><th style="padding:8px">Item</th><th style="padding:8px;text-align:right">Qty</th><th style="padding:8px">Unit</th><th style="padding:8px;text-align:right">Price</th><th style="padding:8px;text-align:right">Subtotal</th></tr></thead><tbody>`;
  html += (p.lines||[]).map(l=>`<tr><td style="padding:6px">${escape(l.itemName)}</td><td style="padding:6px;text-align:right">${l.qty}</td><td style="padding:6px">${escape(l.unit||'')}</td><td style="padding:6px;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td><td style="padding:6px;text-align:right">‚Ç±${(l.qty*l.price).toFixed(2)}</td></tr>`).join('');
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ‚Ç±${(p.total||0).toFixed(2)}</div>`;
  document.getElementById('poViewerContent').innerHTML = html;
  document.getElementById('poViewerModal').classList.add('show');
}
function closePOViewer(){ document.getElementById('poViewerModal').classList.remove('show'); }
function printLastViewedPO(){ if(!lastViewedPO){ showToast('No PO selected'); return; } openPrintableInvoice(lastViewedPO); }

/* Printable invoice (plain white professional) */
function openPrintableInvoice(p){
  const w = window.open('', '_blank');
  const dateText = p.date || new Date(p.createdAt||Date.now()).toISOString().slice(0,10);
  const rows = (p.lines||[]).map(l => `<tr>
    <td style="padding:8px;border:1px solid #ddd">${escape(l.itemName)}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">${l.qty}</td>
    <td style="padding:8px;border:1px solid #ddd">${escape(l.unit||'')}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td>
    <td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${(l.qty*l.price).toFixed(2)}</td>
  </tr>`).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${p.poNumber}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222}table{width:100%;border-collapse:collapse;margin-top:14px}th{background:#f6f6f6;padding:8px;border:1px solid #ddd;text-align:left}td{padding:8px;border:1px solid #ddd} .right{text-align:right}</style>
    </head><body>
    <div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">MSITE Enterprises</h2><div>Purchase Order</div></div><div style="text-align:right"><div><strong>PO#:</strong> ${p.poNumber}</div><div><strong>Date:</strong> ${dateText}</div><div><strong>Customer:</strong> ${escape(p.customer)}</div></div></div>
    <table><thead><tr><th>Item</th><th style="text-align:right">Qty</th><th>Unit</th><th style="text-align:right">Price</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>${rows}</tbody></table>
    <div style="text-align:right;margin-top:12px;font-weight:800">Total: ‚Ç±${(p.total||0).toFixed(2)}</div>
    <div style="margin-top:18px;color:#666;font-size:0.9rem">Printed: ${new Date().toLocaleString()}</div>
    </body></html>`;
  w.document.write(html); w.document.close(); w.focus();
  setTimeout(()=> w.print(),300);
}

/* ---------- Pending / To Purchase (unchanged) ---------- */
/* render pending list */
function renderPendingList(){
  const filter = document.getElementById('pending-filter').value;
  const tbody = document.getElementById('pendingTableBody');
  tbody.innerHTML = '';
  const list = pendingItems.filter(p => {
    if(filter === 'all') return true;
    if(filter === 'pending') return p.status !== 'done';
    if(filter === 'done') return p.status === 'done';
    return true;
  });
  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="5" style="padding:14px;text-align:center;color:var(--muted)">No items</td></tr>`;
    return;
  }
  list.forEach((p, idx)=>{
    const i = pendingItems.indexOf(p); // real index
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="#" onclick="openLinkedStock('${escape(p.item)}');return false;" style="color:var(--accent);text-decoration:none;font-weight:600">${escape(p.item)}</a></td>
      <td class="text-right">${p.qty}</td>
      <td>${escape(p.reason||'')}</td>
      <td>${p.status === 'done' ? '‚úÖ Done' : 'üïí Pending'}</td>
      <td>
         <button class="btn btn-ghost" onclick="editPendingItem(${i})">Edit</button>
         ${p.status !== 'done' ? `<button class="btn btn-primary" onclick="markPendingDone(${i})">Mark Done</button>` : ''}
         <button class="btn btn-ghost" onclick="deletePendingItem(${i})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* show add modal for pending */
function showPendingModal(){
  editingPendingIndex = null;
  document.getElementById('pending-item').value = '';
  document.getElementById('pending-qty').value = '';
  document.getElementById('pending-reason').value = '';
  showModal('modalPending');
}

/* save pending item */
function savePendingItem(){ /* ... existing code preserved below ... */ 
  const item = (document.getElementById('pending-item').value || '').trim();
  const qty = parseFloat(document.getElementById('pending-qty').value) || 0;
  const reason = (document.getElementById('pending-reason').value || '').trim();
  if(!item){ showToast('Enter item name'); return; }
  if(qty <= 0){ showToast('Invalid quantity'); return; }
  const data = { item, qty, reason, status:'pending', createdAt: Date.now() };
  if(editingPendingIndex !== null){
    pendingItems[editingPendingIndex] = data;
  } else {
    pendingItems.push(data);
  }
  pendingRef.set(pendingItems).then(()=> {
    closeModal('modalPending');
    showToast('Saved ‚úî');
  }).catch(err=> {
    console.error(err);
    showToast('Error saving');
  });
}

/* edit pending */
function editPendingItem(i){
  const p = pendingItems[i];
  if(!p) return;
  editingPendingIndex = i;
  document.getElementById('pending-item').value = p.item;
  document.getElementById('pending-qty').value = p.qty;
  document.getElementById('pending-reason').value = p.reason || '';
  showModal('modalPending');
}

/* delete pending */
function deletePendingItem(i){
  if(!confirm('Delete this record?')) return;
  pendingItems.splice(i,1);
  pendingRef.set(pendingItems);
}

/* mark done */
function markPendingDone(i){
  if(!pendingItems[i]) return;
  pendingItems[i].status = 'done';
  pendingRef.set(pendingItems);
}

/* open linked stock and offer to add if missing */
function openLinkedStock(itemName){
  openMenu('stock');
  setTimeout(()=>{
    const rows = document.querySelectorAll('#stockTableBody tr');
    let found = false;
    rows.forEach(row=>{
      const nameCell = row.querySelector('td');
      if(nameCell && nameCell.textContent.trim().toLowerCase() === itemName.toLowerCase()){
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.style.transition = 'background 0.3s ease';
        row.style.background = '#fff9c4'; // highlight yellow
        setTimeout(()=>row.style.background = '',2500);
        found = true;
      }
    });

    if(!found){
      if(confirm(`"${itemName}" not found in stock list.\nAdd it to stock now?`)){
        // open add stock modal and prefill name
        openAddStockPrefill(itemName);
      } else {
        showToast(`"${itemName}" not found in stock list`);
      }
    }
  },300);
}

/* firebase listener for pending */
pendingRef.on('value', snap=>{
  const val = snap.val();
  pendingItems = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  renderPendingList();
});

/* auto-detect low stock (<5) and add to pending if not present */
function checkLowStock(){
  try{
    const low = (window.stockData||[]).filter(s => (parseFloat(s.qty)||0) < 5);
    let changed = false;
    low.forEach(s=>{
      const exists = pendingItems.find(p => p.item.toLowerCase() === (s.name||'').toLowerCase());
      if(!exists){
        pendingItems.push({ item: s.name, qty: Math.max(1, 10 - (parseFloat(s.qty)||0)), reason: 'Low stock ‚Äî auto-added', status:'pending', createdAt: Date.now() });
        changed = true;
      }
    });
    if(changed) pendingRef.set(pendingItems);
  }catch(e){ console.error(e); }
}

/* ---------- Delivery Tracker (grouped by school) ---------- */

/* Render the delivery groups (accordion style) */
function renderDeliveryTracker(){
  const container = document.getElementById('deliveryListContainer');
  const filter = document.getElementById('delivery-filter')?.value || 'all';
  const q = (document.getElementById('delivery-search')?.value || '').toLowerCase().trim();
  container.innerHTML = '';

  const list = (deliveryGroups || []).filter(g => {
    // filter by status: if filter = pending, show groups that have any pending items
    if(filter === 'pending') return g.items.some(it => it.status !== 'delivered');
    if(filter === 'delivered') return g.items.every(it => it.status === 'delivered');
    return true;
  }).filter(g => {
    if(!q) return true;
    return (g.school || '').toLowerCase().includes(q) || g.items.some(it => (it.item||'').toLowerCase().includes(q));
  });

  if(!list.length){
    container.innerHTML = `<div class="muted" style="padding:12px">No delivery groups found.</div>`;
    return;
  }

  // build accordion
  list.forEach(g => {
    const key = g.key || g._key || '';
    const acc = document.createElement('div');
    acc.className = 'accordion';
    // header shows school, counts
    const pendingCount = g.items.filter(it => it.status !== 'delivered').length;
    const totalCount = g.items.length;
    const head = document.createElement('div');
    head.className = 'acc-head';
    head.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:800">${escape(g.school || '‚Äî')}</div>
        <div class="muted small">${totalCount} item(s)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        ${pendingCount ? `<div class="small" style="color:#d98200">üïí ${pendingCount} pending</div>` : `<div class="small" style="color:var(--success)">‚úÖ All delivered</div>`}
        <button class="btn btn-ghost" onclick="editDeliveryGroup('${key}')">Edit</button>
        <button class="btn btn-ghost" onclick="deleteDeliveryGroup('${key}')">Delete</button>
        ${pendingCount ? `<button class="btn btn-primary" onclick="markGroupDelivered('${key}')">Mark All Delivered</button>` : ''}
      </div>`;
    head.onclick = function(e){
      // toggle body (but don't toggle when clicking buttons)
      if(e.target.tagName.toLowerCase()==='button') return;
      body.style.display = body.style.display === 'block' ? 'none' : 'block';
    };

    const body = document.createElement('div');
    body.className = 'acc-body';
    body.style.display = 'none';
    // body contains a table of items for this school
    let rows = `<table style="width:100%;border-collapse:collapse"><thead class="delivery-head"><tr><th>Item</th><th style="width:110px">Qty</th><th>Reason</th><th style="width:120px">Status</th><th style="width:200px">Action</th></tr></thead><tbody>`;
    g.items.forEach((it, idx) => {
      rows += `<tr>
        <td><a href="#" onclick="openLinkedStockFromDelivery('${escape(it.item)}','${key}');return false;" style="color:var(--accent);text-decoration:none;font-weight:600">${escape(it.item)}</a></td>
        <td class="text-right">${it.qty}</td>
        <td>${escape(it.reason||'')}</td>
        <td>${it.status === 'delivered' ? '‚úÖ Delivered' : 'üïí Pending'}</td>
        <td>
          ${it.status !== 'delivered' ? `<button class="btn btn-primary" onclick="markItemDelivered('${key}', ${idx})">Mark Delivered</button>` : ''}
          <button class="btn btn-ghost" onclick="removeDeliveryItem('${key}', ${idx})">Remove</button>
        </td>
      </tr>`;
    });
    rows += '</tbody></table>';
    body.innerHTML = rows;

    acc.appendChild(head);
    acc.appendChild(body);
    container.appendChild(acc);
  });
}

/* Show modal to add/edit a delivery group */
function showAddDeliveryModal(){
  editingDeliveryKey = null;
  tempDeliveryLines = [];
  document.getElementById('delivery-school').value = '';
  renderDeliveryLinesInModal();
  showModal('modalDelivery');
}

/* Add a blank line in modal */
function addDeliveryLine(prefill){
  tempDeliveryLines.push(prefill || { item:'', qty:1, reason:'', status:'pending', createdAt: Date.now() });
  renderDeliveryLinesInModal();
}

/* Remove line in modal */
function removeDeliveryLine(idx){
  tempDeliveryLines.splice(idx,1);
  renderDeliveryLinesInModal();
}

/* Render the dynamic lines inside the delivery modal */
function renderDeliveryLinesInModal(){
  const area = document.getElementById('delivery-lines-area');
  area.innerHTML = '';
  if(!tempDeliveryLines.length){
    area.innerHTML = `<div class="muted" style="padding:10px">No item lines yet. Click "+ Add Item Line" to add missing items for this school.</div>`;
    return;
  }
  tempDeliveryLines.forEach((ln, idx) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '8px';
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <input placeholder="Item name" value="${escape(ln.item)}" style="flex:2;padding:8px;border:1px solid var(--border);border-radius:8px" oninput="updateTempLine(${idx}, 'item', this.value)">
      <input type="number" min="1" value="${ln.qty}" style="width:96px;padding:8px;border:1px solid var(--border);border-radius:8px" oninput="updateTempLine(${idx}, 'qty', this.value)">
      <input placeholder="Reason" value="${escape(ln.reason)}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:8px" oninput="updateTempLine(${idx}, 'reason', this.value)">
      <button class="btn btn-ghost" onclick="removeDeliveryLine(${idx})">Remove</button>
    `;
    area.appendChild(div);
  });
}

/* update a temp line field */
function updateTempLine(idx, field, value){
  if(field === 'qty') value = parseFloat(value) || 0;
  tempDeliveryLines[idx][field] = value;
}

/* Save the delivery group (new or edit) */
function saveDeliveryGroup(){
  const school = (document.getElementById('delivery-school').value || '').trim();
  if(!school){ showToast('Enter school / customer name'); return; }
  if(!tempDeliveryLines.length){ showToast('Add at least one item line'); return; }
  // validate lines
  for(const ln of tempDeliveryLines){
    if(!ln.item || (parseFloat(ln.qty)||0) <= 0){ showToast('Each line needs item and qty'); return; }
  }

  // Prepare group
  const group = {
    school,
    items: tempDeliveryLines.map(l => ({ item: l.item, qty: (parseFloat(l.qty)||0), reason: l.reason||'', status: l.status||'pending', createdAt: l.createdAt || Date.now() })),
    createdAt: Date.now()
  };

  if(editingDeliveryKey){
    // update existing group
    deliveryRef.child(editingDeliveryKey).set(group).then(()=> {
      showToast('Group updated');
      closeModal('modalDelivery');
    }).catch(e=> { console.error(e); showToast('Error saving group'); });
  } else {
    // push new group
    const p = deliveryRef.push();
    p.set(group).then(()=> {
      showToast('Group saved');
      closeModal('modalDelivery');
    }).catch(e=> { console.error(e); showToast('Error saving'); });
  }
}

/* Edit an existing group: open modal with prefilled lines */
function editDeliveryGroup(key){
  const g = deliveryGroups.find(x => x.key === key);
  if(!g) return;
  editingDeliveryKey = key;
  document.getElementById('delivery-school').value = g.school || '';
  tempDeliveryLines = (g.items || []).map(it => ({ item: it.item, qty: it.qty, reason: it.reason || '', status: it.status || 'pending', createdAt: it.createdAt || Date.now() }));
  renderDeliveryLinesInModal();
  showModal('modalDelivery');
}

/* Delete group */
function deleteDeliveryGroup(key){
  if(!confirm('Delete this delivery group?')) return;
  deliveryRef.child(key).remove();
}

/* mark group delivered (all items marked) */
function markGroupDelivered(key){
  const g = deliveryGroups.find(x => x.key === key);
  if(!g) return;
  g.items = g.items.map(it => ({ ...it, status: 'delivered', deliveredAt: Date.now() }));
  deliveryRef.child(key).set({ school: g.school, items: g.items, createdAt: g.createdAt || Date.now() });
}

/* remove a single item from a group */
function removeDeliveryItem(key, idx){
  const g = deliveryGroups.find(x=> x.key === key);
  if(!g) return;
  g.items.splice(idx,1);
  deliveryRef.child(key).set({ school: g.school, items: g.items, createdAt: g.createdAt || Date.now() });
}

/* mark a single item delivered */
function markItemDelivered(key, idx){
  const g = deliveryGroups.find(x=> x.key === key);
  if(!g) return;
  if(!g.items[idx]) return;
  g.items[idx].status = 'delivered';
  g.items[idx].deliveredAt = Date.now();
  deliveryRef.child(key).set({ school: g.school, items: g.items, createdAt: g.createdAt || Date.now() });
}

/* clicking item in delivery opens linked stock; if missing offers to add and prefill school when adding */
function openLinkedStockFromDelivery(itemName, groupKey){
  openMenu('stock');
  setTimeout(()=>{
    const rows = document.querySelectorAll('#stockTableBody tr');
    let found = false;
    rows.forEach(row=>{
      const nameCell = row.querySelector('td');
      if(nameCell && nameCell.textContent.trim().toLowerCase() === itemName.toLowerCase()){
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.style.transition = 'background 0.3s ease';
        row.style.background = '#fff9c4'; // highlight
        setTimeout(()=>row.style.background = '',2500);
        found = true;
      }
    });

    if(!found){
      if(confirm(`"${itemName}" not found in stock list.\nAdd it to stock now?`)){
        openAddStockPrefill(itemName);
      } else {
        showToast(`"${itemName}" not found in stock list`);
      }
    }
  },300);
}

/* listen to deliveryRef changes */
deliveryRef.on('value', snap=>{
  const val = snap.val();
  // convert to array of { key, school, items, createdAt }
  deliveryGroups = [];
  if(val){
    if(typeof val === 'object'){
      Object.keys(val).forEach(k => {
        const v = val[k];
        deliveryGroups.push({ key: k, school: v.school || '', items: Array.isArray(v.items) ? v.items : (v.items ? Object.values(v.items) : []), createdAt: v.createdAt || Date.now() });
      });
    }
  }
  renderDeliveryTracker();
});

/* ---------- Print Stock List (unchanged) ---------- */
function printStockList() {
  const printWindow = window.open('', '_blank');
  const tableHTML = `
    <table style="width:100%;border-collapse:collapse;margin-top:14px">
      <thead>
        <tr style="background:#0073e6;color:white">
          <th style="padding:8px;border:1px solid #ccc;text-align:left">Item</th>
          <th style="padding:8px;border:1px solid #ccc;text-align:right">Quantity</th>
          <th style="padding:8px;border:1px solid #ccc;text-align:left">Unit</th>
          <th style="padding:8px;border:1px solid #ccc;text-align:right">Price</th>
        </tr>
      </thead>
      <tbody>
        ${window.stockData.map(s=>`
          <tr>
            <td style="padding:8px;border:1px solid #ccc">${escape(s.name)}</td>
            <td style="padding:8px;border:1px solid #ccc;text-align:right">${s.qty}</td>
            <td style="padding:8px;border:1px solid #ccc">${escape(s.unit||'')}</td>
            <td style="padding:8px;border:1px solid #ccc;text-align:right">‚Ç±${(parseFloat(s.price)||0).toFixed(2)}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;

  printWindow.document.write(`
    <html><head><title>Stock List</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222;}
      h2{margin:0;text-align:center;color:#0073e6;}
      table{width:100%;border-collapse:collapse;}
      th,td{border:1px solid #ccc;padding:8px;text-align:left;}
      th{background:#0073e6;color:#fff;}
      tr:nth-child(even){background:#f8faff;}
    </style></head>
    <body>
      <h2>MSITE Stock List</h2>
      <div style="text-align:center;font-size:0.9rem;color:#555;">
        Printed: ${new Date().toLocaleString()}
      </div>
      ${tableHTML}
    </body></html>
  `);
  printWindow.document.close();
  setTimeout(()=>printWindow.print(),300);
}

/* ---------- Summary ---------- */
function refreshSummary(){
  document.getElementById('summary-count').textContent = (window.stockData||[]).filter(Boolean).length;
  document.getElementById('summary-total').textContent = (window.stockData||[]).reduce((s,i)=> s + (parseFloat(i.qty)||0), 0);
  posRef.once('value').then(snap => {
    const val = snap.val(); document.getElementById('summary-pos').textContent = val ? Object.keys(val).length : 0;
  }).catch(()=>{});
}

/* ---------- Utilities ---------- */
function escape(s){ if(s===undefined || s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  openMenu('dashboard');
  renderStock();
  initPOForm();
  renderPOList();
  refreshSummary();
  posRef.on('value', ()=> renderPOList());
  pendingRef.on('value', snap=>{
    const val = snap.val();
    pendingItems = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
    renderPendingList();
  });
  // initial delivery load handled by deliveryRef.on above
  setTimeout(()=> checkLowStock(), 700);
});

  // Mobile sidebar toggle
document.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.getElementById('sidebar');
  const hamburger = document.createElement('button');
  hamburger.className = 'hamburger';
  hamburger.textContent = '‚ò∞ Menu';
  hamburger.onclick = () => sidebar.classList.toggle('show');
  document.querySelector('.topbar').prepend(hamburger);
});
  // Register the service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('‚úÖ Service Worker registered:', reg))
      .catch(err => console.error('Service Worker failed:', err));
  });
}
/* ---------- Dashboard Charts (Enhanced) ---------- */
let schoolChart, itemChart;
let allSchoolsData = [];
let allItemsData = [];

function renderDashboardCharts() {
  posRef.once('value').then(snap => {
    const data = snap.val();
    if (!data) return;

    const poArr = Object.values(data);

    // --- Aggregate by School ---
    const schoolTotals = {};
    poArr.forEach(po => {
      if (!po.customer) return;
      schoolTotals[po.customer] = (schoolTotals[po.customer] || 0) + (po.total || 0);
    });
    allSchoolsData = Object.entries(schoolTotals).sort((a, b) => b[1] - a[1]);
    const top5Schools = allSchoolsData.slice(0, 5);

    // --- Aggregate by Item ---
    const itemTotals = {};
    poArr.forEach(po => {
      (po.lines || []).forEach(line => {
        if (!line.itemName) return;
        itemTotals[line.itemName] = (itemTotals[line.itemName] || 0) + (parseFloat(line.qty) || 0);
      });
    });
    allItemsData = Object.entries(itemTotals).sort((a, b) => b[1] - a[1]);
    const top5Items = allItemsData.slice(0, 5);

    // --- Top 5 Schools Chart ---
    const ctx1 = document.getElementById('topSchoolsChart').getContext('2d');
    if (schoolChart) schoolChart.destroy();
    schoolChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: top5Schools.map(s => s[0]),
        datasets: [{
          label: '‚Ç± Total Purchases',
          data: top5Schools.map(s => s[1]),
          backgroundColor: [
            'rgba(0,115,230,0.8)',
            'rgba(13,148,136,0.8)',
            'rgba(245,158,11,0.8)',
            'rgba(239,68,68,0.8)',
            'rgba(99,102,241,0.8)'
          ],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: 'Top 5 Schools by Total Purchases', color: '#0050b3', font: { size: 14, weight: 'bold' } },
          legend: { display: false }
        },
        scales: { y: { beginAtZero: true, title: { display: true, text: '‚Ç± Value' } } }
      }
    });

    // --- Best-Selling Items Chart ---
    const ctx2 = document.getElementById('bestItemsChart').getContext('2d');
    if (itemChart) itemChart.destroy();
    itemChart = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: top5Items.map(i => i[0]),
        datasets: [{
          label: 'Qty Sold',
          data: top5Items.map(i => i[1]),
          backgroundColor: [
            '#0073e6', '#0d9488', '#f59e0b', '#ef4444', '#6366f1'
          ]
        }]
      },
      options: {
        plugins: {
          title: { display: true, text: 'Top 5 Best-Selling Items', color: '#0050b3', font: { size: 14, weight: 'bold' } },
          legend: { position: 'bottom' }
        }
      }
    });

    // --- Add full tables under charts ---
    renderFullSchoolAndItemTables();
  });
}

/* Render complete school + item tables */
function renderFullSchoolAndItemTables() {
  const container = document.getElementById('dashboard-summary-tables');
  container.innerHTML = `
    <div class="card" style="overflow:auto;margin-top:20px">
      <h4 style="margin-bottom:6px;color:var(--accent-2)">All Schools Summary</h4>
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
        <thead><tr style="background:#f0f8ff"><th style="text-align:left;padding:6px">School</th><th style="text-align:right;padding:6px">‚Ç± Total</th></tr></thead>
        <tbody>
          ${allSchoolsData.map(s=>`
            <tr><td style="padding:6px;border-bottom:1px solid #eee">${s[0]}</td>
            <td style="padding:6px;text-align:right;border-bottom:1px solid #eee">‚Ç±${s[1].toLocaleString()}</td></tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <div class="card" style="overflow:auto;margin-top:20px">
      <h4 style="margin-bottom:6px;color:var(--accent-2)">All Best-Selling Items</h4>
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
        <thead><tr style="background:#f0f8ff"><th style="text-align:left;padding:6px">Item</th><th style="text-align:right;padding:6px">Qty Sold</th></tr></thead>
        <tbody>
          ${allItemsData.map(i=>`
            <tr><td style="padding:6px;border-bottom:1px solid #eee">${i[0]}</td>
            <td style="padding:6px;text-align:right;border-bottom:1px solid #eee">${i[1]}</td></tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

/* Extend navigation to refresh charts */
function openMenu(menuId) {
  document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
  document.getElementById(menuId).style.display = 'block';
  document.getElementById('pageTitle').textContent = {
    dashboard: 'Dashboard',
    stock: 'Stock Management',
    po: 'Purchase Orders',
    pending: 'Pending / To Purchase',
    delivery: 'Delivery Tracker'
  }[menuId] || 'MSITE';
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(`nav-${menuId}`).classList.add('active');
  
  if (menuId === 'dashboard') {
    renderDashboardCharts();
    refreshSummary();
  }
}


/* ---------- End ---------- */
  /* ---------- PURCHASE ORDER LOGIC (for new layout) ---------- */

// Initialize blank order lines
function addPOLine() {
  const tbody = document.getElementById("poLineTableBody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td style="padding:6px"><input class="input itemName" placeholder="Item name" style="width:100%"></td>
    <td style="padding:6px;text-align:center"><input type="number" class="input qty" min="1" value="1" style="width:60px"></td>
    <td style="padding:6px;text-align:center"><input class="input unit" placeholder="pcs" style="width:80px"></td>
    <td style="padding:6px;text-align:center"><input type="number" class="input price" step="0.01" placeholder="0.00" style="width:100px"></td>
    <td style="padding:6px;text-align:center" class="subtotal">‚Ç±0.00</td>
    <td style="padding:6px;text-align:center"><button class="btn btn-ghost" onclick="this.closest('tr').remove(); updatePOTotal();">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(tr);

  // update total when qty or price changes
  const qtyInput = tr.querySelector(".qty");
  const priceInput = tr.querySelector(".price");
  qtyInput.addEventListener("input", () => updateSubtotal(tr));
  priceInput.addEventListener("input", () => updateSubtotal(tr));
}

function updateSubtotal(row) {
  const qty = parseFloat(row.querySelector(".qty").value) || 0;
  const price = parseFloat(row.querySelector(".price").value) || 0;
  const subtotal = qty * price;
  row.querySelector(".subtotal").textContent = `‚Ç±${subtotal.toFixed(2)}`;
  updatePOTotal();
}

function updatePOTotal() {
  const rows = document.querySelectorAll("#poLineTableBody tr");
  let total = 0;
  rows.forEach(r => {
    const txt = r.querySelector(".subtotal").textContent.replace(/[‚Ç±,]/g,"");
    total += parseFloat(txt) || 0;
  });
  document.getElementById("poTotal").textContent = `‚Ç±${total.toLocaleString(undefined,{minimumFractionDigits:2})}`;
}

/* ---------- SAVE PO TO FIREBASE ---------- */
function savePO() {
  const customer = document.getElementById("poCustomer").value.trim();
  const date = document.getElementById("poDate").value;
  const remarks = document.getElementById("poRemarks").value.trim();
  const poNumber = "PO-" + Date.now().toString().slice(-6);

  const lines = [];
  document.querySelectorAll("#poLineTableBody tr").forEach(r => {
    const itemName = r.querySelector(".itemName").value.trim();
    const qty = parseFloat(r.querySelector(".qty").value) || 0;
    const unit = r.querySelector(".unit").value.trim();
    const price = parseFloat(r.querySelector(".price").value) || 0;
    if (itemName && qty > 0) {
      lines.push({ itemName, qty, unit, price });
    }
  });

  if (!customer || lines.length === 0) {
    alert("Please fill in customer name and add at least one item.");
    return;
  }

  const total = lines.reduce((sum, i) => sum + i.qty * i.price, 0);

  const poData = {
    poNumber,
    date: date || new Date().toISOString().split("T")[0],
    customer,
    remarks,
    total,
    lines,
    createdAt: Date.now()
  };

  // Save to Firebase (assuming posRef is your purchase order reference)
  posRef.child(poNumber).set(poData)
    .then(() => {
      // Deduct from stock
      lines.forEach(line => {
        stockRef.orderByChild("name").equalTo(line.itemName).once("value", snap => {
          snap.forEach(child => {
            const currentQty = child.val().qty || 0;
            child.ref.update({ qty: Math.max(0, currentQty - line.qty) });
          });
        });
      });
      alert("‚úÖ Purchase Order Saved!");
      resetPOForm();
      renderPOList(); // refresh list
    })
    .catch(err => {
      console.error(err);
      alert("Error saving PO: " + err.message);
    });
}

/* ---------- RESET FORM ---------- */
function resetPOForm() {
  document.getElementById("poCustomer").value = "";
  document.getElementById("poDate").value = "";
  document.getElementById("poRemarks").value = "";
  document.getElementById("poLineTableBody").innerHTML = "";
  document.getElementById("poTotal").textContent = "‚Ç±0.00";
}

/* ---------- PRINT PO ---------- */
function printPO() {
  const customer = document.getElementById("poCustomer").value || "N/A";
  const date = document.getElementById("poDate").value || "N/A";
  const total = document.getElementById("poTotal").textContent;

  let html = `
    <h2>Purchase Order</h2>
    <p><strong>Customer:</strong> ${customer}<br>
    <strong>Date:</strong> ${date}</p>
    <table border="1" cellspacing="0" cellpadding="6" width="100%">
      <thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Subtotal</th></tr></thead>
      <tbody>
  `;
  document.querySelectorAll("#poLineTableBody tr").forEach(r => {
    const item = r.querySelector(".itemName").value;
    const qty = r.querySelector(".qty").value;
    const unit = r.querySelector(".unit").value;
    const price = r.querySelector(".price").value;
    const subtotal = r.querySelector(".subtotal").textContent;
    html += `<tr><td>${item}</td><td>${qty}</td><td>${unit}</td><td>${price}</td><td>${subtotal}</td></tr>`;
  });
  html += `
      </tbody></table>
      <h3 style="text-align:right">Total: ${total}</h3>
  `;

  const newWin = window.open("", "_blank");
  newWin.document.write(html);
  newWin.document.close();
  newWin.print();
}

  
</script>
</body>
</html>
