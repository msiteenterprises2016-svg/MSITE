<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSITE Inventory ‚Äî Modern Dashboard</title>
  <meta name="theme-color" content="#0b6ff2" />
  <link rel="icon" href="msite.png?v=2.0.0" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap');

:root {
  --accent: #3B82F6;       /* sapphire blue */
  --accent-2: #8B5CF6;     /* violet glow */
  --accent-3: #06B6D4;     /* cyan highlight */
  --text-main: #E2E8F0;    /* soft white */
  --text-muted: #94A3B8;
  --bg-dark: #0B1120;
  --border: rgba(255,255,255,0.06);
  --radius: 14px;
  --shadow-1: 0 10px 30px rgba(0,0,0,0.5);
  --shadow-2: 0 6px 18px rgba(0,0,0,0.35);
  --max-w: 1200px;
  --sidebar-w: 260px;
}

/* ---------- BACKGROUND ---------- */
body {
  margin: 0;
  font-family: 'Poppins','DM Sans',system-ui,sans-serif;
  color: var(--text-main);
  background: linear-gradient(135deg,#0B1120,#111B36,#1E293B,#0F172A);
  background-size: 400% 400%;
  animation: gradientShift 28s ease infinite;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
@keyframes gradientShift {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

/* ---------- LAYOUT ---------- */
.app{min-height:100vh;display:flex;justify-content:center;padding:28px 20px;}
.container{width:100%;max-width:var(--max-w);display:flex;gap:20px;align-items:flex-start;}

/* ---------- SIDEBAR ---------- */
aside.sidebar{
  width:var(--sidebar-w);
  background:rgba(17,24,39,0.7);
  backdrop-filter:blur(14px);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
  box-shadow:var(--shadow-2);
  position:sticky;top:28px;height:calc(100vh - 56px);
  overflow:auto;transition:background .4s ease;
}
aside.sidebar:hover{background:rgba(31,41,55,0.8);}
.brand{
  font-family:'DM Sans',sans-serif;font-weight:800;text-align:center;
  padding:12px 6px;font-size:20px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2),var(--accent-3));
  -webkit-background-clip:text;color:transparent;
}

/* ---------- NAV ---------- */
.nav{list-style:none;padding:0;margin:10px 0;display:flex;flex-direction:column;gap:6px;}
.nav button{
  display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:12px;
  border:0;background:transparent;font-weight:600;color:var(--text-muted);
  cursor:pointer;transition:all .25s ease;
}
.nav button:hover{
  background:linear-gradient(90deg,rgba(59,130,246,0.15),rgba(139,92,246,0.10));
  transform:translateX(4px);color:#fff;
}
.nav button.active{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;box-shadow:0 0 16px rgba(59,130,246,0.3);
}

/* ---------- MAIN ---------- */
main.main{flex:1;display:flex;flex-direction:column;gap:18px;min-width:0;}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;color:var(--text-main);}
.page-title{font-size:1.5rem;font-weight:700;font-family:'DM Sans';}

/* ---------- CARDS ---------- */
.card{
  background:rgba(30,41,59,0.65);
  border-radius:var(--radius);
  padding:18px;
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:var(--shadow-2);
  backdrop-filter:blur(18px);
  transition:all .25s ease;
}
.card:hover{background:rgba(51,65,85,0.8);transform:translateY(-3px);}
.card-lg{padding:22px;border-radius:16px;}
.muted{color:var(--text-muted);font-size:.95rem;}
.small{font-size:.9rem;color:var(--text-muted);}

/* ---------- BUTTONS ---------- */
.btn{
  padding:10px 16px;border-radius:10px;border:0;font-weight:600;
  cursor:pointer;transition:all .2s ease;letter-spacing:.01em;
}
.btn-primary{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;box-shadow:0 8px 24px rgba(59,130,246,0.35);
}
.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 28px rgba(139,92,246,0.45);
}
.btn-ghost{
  background:transparent;border:1px solid rgba(255,255,255,0.1);
  color:var(--text-main);
}
.btn-ghost:hover{
  background:rgba(59,130,246,0.15);
  color:#fff;
}

/* ---------- TABLES ---------- */
table{width:100%;border-collapse:collapse;font-size:.95rem;color:var(--text-main);}
thead th{
  background:rgba(59,130,246,0.15);color:#e2e8f0;text-align:left;
  padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);font-weight:600;
}
tbody td{
  padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:middle;
}
tbody tr:hover td{background:rgba(59,130,246,0.08);}

/* ---------- INPUTS ---------- */
input,select,textarea{
  padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
  outline:none;background:rgba(255,255,255,0.05);color:var(--text-main);
  min-height:40px;transition:all .2s ease;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(59,130,246,0.2);
}

/* ---------- TOAST ---------- */
#toast{
  position:fixed;right:20px;bottom:20px;padding:12px 16px;border-radius:10px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;box-shadow:var(--shadow-1);opacity:0;
  transform:translateY(10px);transition:all .28s ease;
}

/* ---------- RESPONSIVE ---------- */
@media(max-width:980px){
  .container{flex-direction:column;padding:12px;}
  aside.sidebar{display:none;position:fixed;left:0;top:0;height:100vh;z-index:1200;}
  .hamburger{display:inline-flex;}
}


 /* ---------- MOBILE SIDEBAR TOGGLE (Dark Mode) ---------- */
.hamburger {
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 44px;
  height: 44px;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  transition: all 0.25s ease;
}
.hamburger:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 14px rgba(59,130,246,0.4);
}

@media (max-width:980px){
  .hamburger { display: inline-flex; }

  aside.sidebar {
    display: none;
    position: fixed;
    left: 0; top: 0;
    width: var(--sidebar-w);
    height: 100vh;
    transform: translateX(-100%);
    background: rgba(17,24,39,0.92); /* dark glass */
    backdrop-filter: blur(12px);
    border-right: 1px solid rgba(255,255,255,0.05);
    box-shadow: 8px 0 24px rgba(0,0,0,0.4);
    transition: transform 0.35s ease;
    z-index: 1200;
  }

  aside.sidebar.show {
    display: block;
    transform: translateX(0);
  }

  #poLineTableBody tr:hover td {
  background: rgba(59,130,246,0.08);
  transition: background 0.25s ease;
}

}



  </style>
</head>

<body>
  <div class="app">
    <div class="container">

      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="brand">MSITE Inventory</div>
        <nav>
          <ul class="nav">
            <li><button id="nav-dashboard" class="active" onclick="openMenu('dashboard')">üè† Dashboard</button></li>
            <li><button id="nav-stock" onclick="openMenu('stock')">üì¶ Stock</button></li>
            <li><button id="nav-po" onclick="openMenu('po')">üßæ Purchase Orders</button></li>
            <li><button id="nav-pohistory" onclick="openMenu('pohistory')">üìú PO History</button></li>
          </ul>
        </nav>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <div class="small muted">Signed in: <strong>MSITE</strong></div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <div class="topbar">
        <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
          <div class="page-title" id="pageTitle">Dashboard</div>
          <div class="row">
            <button class="btn btn-ghost" onclick="renderStock()">‚ü≥ Refresh</button>
          
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="card card-lg page">
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border)">
              <div class="small muted">Total unique items</div>
              <div id="summary-count" style="font-size:1.2rem;font-weight:800;color:var(--accent-2)">0</div>
            </div>
            <div style="flex:1;min-width:200px;background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border)">
              <div class="small muted">Total stock (sum qty)</div>
              <div id="summary-total" style="font-size:1.2rem;font-weight:800;color:var(--accent-2)">0</div>
            </div>
            <div style="flex:1;min-width:200px;background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border)">
              <div class="small muted">Purchase orders filed</div>
              <div id="summary-pos" style="font-size:1.2rem;font-weight:800;color:var(--accent-2)">0</div>
            </div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)" />
          <h3 style="margin:6px 0;color:var(--accent-2)">Recent Purchase Orders</h3>
          <div id="recentPOsContainer" class="muted-2">Loading...</div>

          <hr style="margin:18px 0;border:none;border-top:1px solid var(--border)" />
          <h3 style="color:var(--accent-2)">üìä Sales Insights</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-top:12px">
            <div class="card" style="padding:14px;">
              <h4 style="margin:0 0 8px 0;color:var(--accent-2)">Top Schools (by total)</h4>
              <div style="height:220px"><canvas id="topSchoolsChart"></canvas></div>
            </div>
            <div class="card" style="padding:14px;">
              <h4 style="margin:0 0 8px 0;color:var(--accent-2)">Best-Selling Items</h4>
              <div style="height:220px"><canvas id="bestItemsChart"></canvas></div>
            </div>
          </div>

          <div id="dashboard-summary-tables" style="margin-top:16px"></div>
        </section>

        <!-- STOCK -->
        <section id="stock" class="card page" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 style="margin:0;color:var(--accent-2)">Stock Management</h3>
              <div class="small muted">Add and manage products ‚Äî changes save to Firebase.</div>
            </div>
            <div class="row">
              <input id="search" placeholder="Search items..." oninput="renderStock()" />
              <button class="btn btn-primary" onclick="showAddStockModal()">+ Add Item</button>
              <button class="btn btn-ghost" onclick="printStockList()">üñ® Print</button>
            </div>
          </div>

          <div style="margin-top:14px;overflow:auto">
            <table>
              <thead>
                <tr><th>Name</th><th style="width:120px">Qty</th><th style="width:120px">Unit</th><th style="width:140px">Price</th><th style="width:160px">Action</th></tr>
              </thead>
              <tbody id="stockTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- PURCHASE ORDERS -->
        <section id="po" class="card page" style="display:none">
          <div>
            <h2 style="color:var(--accent-2);margin:0 0 8px 0">üßæ Create Purchase Order</h2>
            <p class="muted small" style="margin:0 0 12px 0">Record new orders and deduct stock automatically.</p>
          </div>

          <div style="background:var(--card);padding:18px;border-radius:12px;border:1px solid var(--border);display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
            <div>
              <label class="small muted">PO Number</label>
              <input id="poNumber" readonly />
            </div>
            <div>
              <label class="small muted">Date</label>
              <input id="poDate" type="date" />
            </div>
            <div>
              <label class="small muted">School / Customer</label>
              <input id="poCustomer" placeholder="Enter school name" />
            </div>
            <div>
              <label class="small muted">Remarks</label>
              <input id="poRemarks" placeholder="Optional note" />
            </div>
          </div>

         <div style="background:rgba(30,41,59,0.65);margin-top:14px;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.05);box-shadow:var(--shadow-2);backdrop-filter:blur(18px);">

            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <h3 style="margin:0;color:var(--accent-2)">Order Items</h3>
              <div>
                <button class="btn btn-primary" onclick="addPOLine()">+ Add Item</button>
                <button class="btn btn-ghost" onclick="clearPOLines()">Clear</button>
              </div>
            </div>

            <div style="overflow:auto;">
              <table style="min-width:700px">
                <thead>
<tr style="background:rgba(59,130,246,0.15);color:#e2e8f0;">
                    <th style="padding:10px">#</th>
                    <th style="padding:10px">Item</th>
                    <th style="padding:10px;text-align:center">Qty</th>
                    <th style="padding:10px;text-align:center">Unit</th>
                    <th style="padding:10px;text-align:center">Price</th>
                    <th style="padding:10px;text-align:right">Subtotal</th>
                    <th style="padding:10px;text-align:center">Action</th>
                  </tr>
                </thead>
                <tbody id="poLineTableBody"></tbody>
              </table>
            </div>

            <div style="text-align:right;margin-top:14px">
              <span class="muted">Total:</span>
              <div id="poTotal" style="font-size:1.4rem;font-weight:800;color:var(--accent-2);display:inline-block;margin-left:8px">‚Ç±0.00</div>
            </div>
          </div>

          <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
            <button class="btn btn-ghost" onclick="resetPOForm()">Reset</button>
            <button class="btn btn-ghost" onclick="openPrintableInvoiceFromForm()">Print Preview</button>
            <button class="btn btn-primary" onclick="savePO()">Save PO</button>
          </div>
        </section>
        

        <!-- PO HISTORY -->
        <section id="pohistory" class="card page" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h2 style="margin:0;color:var(--accent-2)">üìú Purchase Order History</h2>
              <div class="small muted">All saved POs ‚Äî view or delete records.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="historySearch" placeholder="Search PO# or customer..." oninput="renderPOHistory()" style="min-width:220px" />
              <button class="btn btn-ghost" onclick="renderPOHistory()">Refresh</button>
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto">
            <div id="poHistoryContainer">Loading PO history...</div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- MODALS -->
  <div id="modalAddStock" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(8,12,20,0.45);z-index:999">
    <div style="background:white;border-radius:12px;padding:16px;min-width:360px;border:1px solid var(--border);box-shadow:var(--shadow-1)">
      <h3 style="margin:0 0 8px 0;color:var(--accent)">Add / Edit Stock</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <div style="flex:1;min-width:160px">
          <label class="small muted">Item name</label>
          <input id="modal-stock-name" placeholder="Item name" />
        </div>
        <div style="width:120px">
          <label class="small muted">Quantity</label>
          <input id="modal-stock-qty" type="number" min="0" />
        </div>
        <div style="width:120px">
          <label class="small muted">Unit</label>
          <input id="modal-stock-unit" />
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div style="width:150px">
          <label class="small muted">Price</label>
          <input id="modal-stock-price" type="number" step="0.01" />
        </div>

        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" onclick="saveStockFromModal()">Save</button>
          <button class="btn btn-ghost" onclick="closeAddStockModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PO Viewer modal -->
  <div id="poViewerModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(8,12,20,0.45);z-index:999">
    <div style="background:white;border-radius:12px;padding:16px;min-width:520px;border:1px solid var(--border);box-shadow:var(--shadow-1)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--accent)">Purchase Order</h3>
        <div><button class="btn btn-ghost" onclick="closePOViewer()">Close</button></div>
      </div>

      <div id="poViewerContent" style="margin-top:12px"></div>

      <div style="text-align:right;margin-top:12px">
        <button class="btn btn-primary" onclick="printLastViewedPO()">üñ® Print</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <script>
    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCRaNvNt2aVsJeI51gagE3XMRG_hnDA8aY",
      authDomain: "msite-45cd2.firebaseapp.com",
      databaseURL: "https://msite-45cd2-default-rtdb.firebaseio.com/",
      projectId: "msite-45cd2",
      storageBucket: "msite-45cd2.firebasestorage.app",
      messagingSenderId: "634058871629",
      appId: "1:634058871629:web:e92190c30153f56cf41d04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const stocksRef = db.ref("stocks");
    const posRef = db.ref("purchaseOrders");

    /* ---------- state ---------- */
    window.stockData = JSON.parse(localStorage.getItem("stockData") || "[]");
    window.poLines = [];
    let editingStockIndex = null;
    let lastViewedPO = null;
    let schoolChart = null, itemChart = null, chartUpdateTimer = null;

 // ---------- CHART DARK MODE SYNC ----------
if (window.schoolChart) {
  const ctx = schoolChart.ctx;
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(59,130,246,0.9)');   // Sapphire blue
  gradient.addColorStop(1, 'rgba(139,92,246,0.25)');  // Violet fade

  schoolChart.data.datasets.forEach(ds => {
    ds.borderColor = 'rgba(59,130,246,1)';
    ds.backgroundColor = gradient;
    ds.pointBackgroundColor = '#06B6D4';   // Cyan points
    ds.pointBorderColor = '#fff';
  });

  schoolChart.options.plugins = schoolChart.options.plugins || {};
  schoolChart.options.plugins.legend = {
    labels: { color: '#E2E8F0', font: { family: 'DM Sans', weight: '500' } }
  };
  schoolChart.options.scales = {
    x: { ticks: { color: '#94A3B8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
    y: { ticks: { color: '#94A3B8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
  };
  schoolChart.update();
}



    /* ---------- helpers ---------- */
    function showToast(msg, time = 2200) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.opacity = '1';
      t.style.transform = 'translateY(0)';
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; }, time);
    }
    function showModalById(id){ document.getElementById(id).style.display = 'flex'; }
    function hideModalById(id){ document.getElementById(id).style.display = 'none'; }
    function showAddStockModal(){ editingStockIndex = null; document.getElementById('modal-stock-name').value=''; document.getElementById('modal-stock-qty').value=''; document.getElementById('modal-stock-unit').value=''; document.getElementById('modal-stock-price').value=''; showModalById('modalAddStock'); }
    function closeAddStockModal(){ hideModalById('modalAddStock'); }
    function escapeHTML(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    /* ---------- Navigation ---------- */
    function openMenu(menuId){
      document.querySelectorAll('.page').forEach(el=>el.style.display='none');
      document.getElementById(menuId).style.display='block';
      document.getElementById('pageTitle').textContent = { dashboard:'Dashboard', stock:'Stock Management', po:'Purchase Orders', pohistory:'PO History' }[menuId] || 'MSITE';
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      const btn = document.getElementById('nav-' + menuId); if(btn) btn.classList.add('active');
    }

    /* ---------- Stock management ---------- */
   function renderStock() {
  const tbody = document.getElementById('stockTableBody');
  const q = (document.getElementById('search')?.value || '').toLowerCase();
  tbody.innerHTML = '';

  (window.stockData || []).forEach((s, realIndex) => {
    if (!s || !s.name || (q && !s.name.toLowerCase().includes(q))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(s.name)}</td>
      <td style="width:120px">${s.qty}</td>
      <td style="width:120px">${escapeHTML(s.unit || '')}</td>
      <td style="width:140px">‚Ç±${(parseFloat(s.price) || 0).toFixed(2)}</td>
      <td style="width:160px">
        <button class="btn btn-ghost" onclick="openEditStock(${realIndex})">‚úèÔ∏è Edit</button>
        <button class="btn btn-ghost" onclick="deleteStock(${realIndex})">üóë Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}


    function openEditStock(i){ editingStockIndex=i; const s = window.stockData[i]||{}; document.getElementById('modal-stock-name').value=s.name||''; document.getElementById('modal-stock-qty').value=s.qty||0; document.getElementById('modal-stock-unit').value=s.unit||''; document.getElementById('modal-stock-price').value=s.price||0; showModalById('modalAddStock'); }

    function saveStockFromModal(){ 
      const name = (document.getElementById('modal-stock-name').value||'').trim();
      const qty = parseFloat(document.getElementById('modal-stock-qty').value)||0;
      const unit = (document.getElementById('modal-stock-unit').value||'').trim();
      const price = parseFloat(document.getElementById('modal-stock-price').value)||0;
      if(!name){ showToast('Enter item name'); return; } if(qty<0){ showToast('Quantity invalid'); return; } if(price<0){ showToast('Price invalid'); return; }
      if(editingStockIndex === null){ const existing = (window.stockData||[]).find(x=>x.name && x.name.toLowerCase()===name.toLowerCase()); if(existing){ existing.qty = (parseFloat(existing.qty)||0) + qty; existing.unit = unit || existing.unit; existing.price = price || existing.price; } else { window.stockData.push({ name, qty, unit, price }); } showToast('Stock added'); } else { window.stockData[editingStockIndex] = { name, qty, unit, price }; showToast('Stock updated'); }
      closeAddStockModal(); saveStocksToFirebase();
      renderStock();
  document.getElementById('search').dispatchEvent(new Event('input'));
    }

    function deleteStock(i){ if(!confirm('Delete this item?')) return; window.stockData.splice(i,1); saveStocksToFirebase(); renderStock(); refreshSummary();document.getElementById('search').dispatchEvent(new Event('input'));

  showToast('Item deleted');}

    function saveStocksToFirebase(){ const updates = {}; (window.stockData||[]).forEach((it,idx)=>updates[idx]=it); stocksRef.update(updates).then(()=>{ localStorage.setItem('stockData', JSON.stringify(window.stockData||[])); renderStock(); renderPOList(); renderPOHistory(); refreshSummary(); }).catch(e=>console.error(e)); }

    stocksRef.on('value', snap=>{
      const val = snap.val();
      if(val){ window.stockData = Array.isArray(val) ? val : Object.values(val||{}); localStorage.setItem('stockData', JSON.stringify(window.stockData||[])); } else { window.stockData = JSON.parse(localStorage.getItem('stockData')||'[]'); }
      renderStock(); refreshSummary();
    });

    /* ---------- Purchase Orders ---------- */
    function genPONumber(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `PO-${d.getFullYear()}${mm}${dd}-${Math.floor(Math.random()*9000)+1000}`; }
    function initPOForm(){ document.getElementById('poNumber').value = genPONumber(); document.getElementById('poDate').value = (new Date()).toISOString().slice(0,10); document.getElementById('poCustomer').value=''; document.getElementById('poRemarks').value=''; window.poLines=[]; renderPOLines(); renderPOList(); }

    function addPOLine(prefill){ window.poLines.push(prefill || { itemName:'', qty:1, unit:'', price:0 }); renderPOLines(); }
    function clearPOLines(){ window.poLines = []; renderPOLines(); }
    function removePOLine(i){ window.poLines.splice(i,1); renderPOLines(); }

    function updatePOLine(i, field, value){
      if(!window.poLines[i]) return;
      if(field==='qty') value = parseFloat(value)||0;
      if(field==='price') value = parseFloat(value)||0;
      window.poLines[i][field] = value;
      if(field === 'itemName'){ const st = (window.stockData||[]).find(s => s.name === value); if(st){ window.poLines[i].unit = st.unit||''; window.poLines[i].price = st.price||0; } else { window.poLines[i].unit = ''; } }
      renderPOLines();
    }

    function calcLineSubtotal(line){ return ((parseFloat(line.qty)||0) * (parseFloat(line.price)||0)) || 0; }
    function calcPOTotal(){ return (window.poLines||[]).reduce((s,l)=> s + calcLineSubtotal(l), 0); }

    function renderPOLines(){
      const tbody = document.getElementById('poLineTableBody'); tbody.innerHTML='';
      if(!window.poLines.length){ tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;text-align:center;color:var(--muted)">No items. Click "Add Item" to start.</td></tr>`; document.getElementById('poTotal').textContent = `‚Ç±${calcPOTotal().toFixed(2)}`; return; }
      window.poLines.forEach((line,i)=>{
        const subtotal = calcLineSubtotal(line);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class="line-number">${i+1}</td><td><select onchange="updatePOLine(${i}, 'itemName', this.value)"><option value="">-- select product --</option>${ (window.stockData||[]).map(s=>`<option ${s.name===line.itemName?'selected':''} value="${escapeHTML(s.name)}">${escapeHTML(s.name)} (${s.qty} ${escapeHTML(s.unit||'')})</option>`).join('') }</select></td><td style="text-align:center"><input type="number" min="1" value="${line.qty||1}" onchange="updatePOLine(${i}, 'qty', this.value)"></td><td style="text-align:center"><input value="${escapeHTML(line.unit||'')}" onchange="updatePOLine(${i}, 'unit', this.value)"></td><td style="text-align:center"><input type="number" step="0.01" min="0" value="${line.price||0}" onchange="updatePOLine(${i}, 'price', this.value)"></td><td class="subtotal">‚Ç±${subtotal.toFixed(2)}</td><td style="text-align:center"><button class="btn btn-ghost" onclick="removePOLine(${i})">Remove</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('poTotal').textContent = `‚Ç±${calcPOTotal().toFixed(2)}`;
    }

    /* ---------- Save PO (shows details) ---------- */
    function savePO(){
      const cust = (document.getElementById('poCustomer').value || '').trim();
      const date = (document.getElementById('poDate').value || '').trim();
      const poNum = document.getElementById('poNumber').value;
      if(!cust){ showToast('Enter customer/school name'); return; }
      if(!date){ showToast('Choose a date'); return; }
      if(!window.poLines.length){ showToast('Add at least one line'); return; }

      for(const l of window.poLines){
        if(!l.itemName){ showToast('Select product on all lines'); return; }
        if(!(parseFloat(l.qty) > 0)){ showToast(`Invalid qty for ${l.itemName}`); return; }
        const st = (window.stockData||[]).find(s => s.name === l.itemName);
        if(!st){ showToast(`Item not in stock: ${l.itemName}`); return; }
        if(l.qty > st.qty){ showToast(`Not enough stock for ${l.itemName} (available ${st.qty})`); return; }
      }

      if(!confirm(`Submit PO ${poNum}? This will deduct items from stock.`)) return;

      const poObj = {
        poNumber: poNum,
        customer: cust,
        date: date,
        remarks: (document.getElementById('poRemarks').value || '').trim(),
        lines: JSON.parse(JSON.stringify(window.poLines)),
        total: calcPOTotal(),
        createdAt: Date.now()
      };

      // push to Firebase, capture key
      const pushRef = posRef.push();
      pushRef.set(poObj).then(()=>{
        // add id locally (for immediate viewing)
        poObj.id = pushRef.key;

        // deduct local stock and persist
        window.poLines.forEach(l=>{
          const st = (window.stockData||[]).find(s => s.name === l.itemName);
          if(st) st.qty = Math.max(0, (st.qty||0) - (l.qty||0));
        });
        saveStocksToFirebase();

        showToast('PO saved ‚úî');

        // show saved PO details in modal (immediate feedback)
        viewPODetail(poObj);

        // reset form + refresh lists
        initPOForm();
        renderPOList();
        renderPOHistory();
      }).catch(err=>{
        console.error(err);
        showToast('Error saving PO');
      });
    }

    /* ---------- Dashboard PO summary ---------- */
    function renderPOList(){
      const containerId = 'poListContainer';
      let container = document.getElementById(containerId);
      if(!container){
        const holder = document.getElementById('dashboard-summary-tables');
        container = document.createElement('div'); container.id = containerId; holder.appendChild(container);
      }
      container.innerHTML = 'Loading...';

      posRef.orderByChild('createdAt').limitToLast(150).once('value').then(snap=>{
        const data = snap.val();
        if(!data){ container.innerHTML = '<div class="muted">No purchase orders yet.</div>'; refreshSummary(); return; }
        const arr = Object.keys(data).map(k => ({ id:k, ...data[k] })).sort((a,b)=> b.createdAt - a.createdAt);
        let html = `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f6fbff;color:var(--accent-2)"><th style="padding:10px">PO#</th><th>Customer</th><th>Date</th><th>Total</th><th>Action</th></tr></thead><tbody>`;
        html += arr.map(p => `<tr><td style="padding:10px">${p.poNumber}</td><td>${escapeHTML(p.customer)}</td><td>${escapeHTML(p.date)}</td><td>‚Ç±${(p.total||0).toFixed(2)}</td><td><button class="btn btn-ghost" onclick='viewPODetail(${JSON.stringify(p).replace(/'/g,"\\'")})'>View</button></td></tr>`).join('');
        html += '</tbody></table>';
        container.innerHTML = html;

        const recent = arr.slice(0,6);
        document.getElementById('recentPOsContainer').innerHTML = recent.length ? `<ul style="margin:6px 0">${recent.map(r=>`<li style="margin:6px 0"><strong>${r.poNumber}</strong> ‚Äî ${escapeHTML(r.customer)} (${r.date}) ‚Ç±${(r.total||0).toFixed(2)}</li>`).join('')}</ul>` : '<div class="muted">No recent POs</div>';
        refreshSummary();
      }).catch(err => { console.error(err); container.innerHTML = '<div class="muted">Error loading POs</div>'; });
    }

    /* ---------- PO HISTORY (view + delete) ---------- */
    function renderPOHistory(){
      const container = document.getElementById('poHistoryContainer');
      const q = (document.getElementById('historySearch')?.value || '').toLowerCase().trim();
      container.innerHTML = 'Loading PO history...';

      posRef.orderByChild('createdAt').limitToLast(1000).once('value').then(snap=>{
        const data = snap.val();
        if(!data){ container.innerHTML = '<div class="muted">No purchase orders yet.</div>'; return; }
        const arr = Object.keys(data).map(k => ({ id:k, ...data[k] })).sort((a,b)=> b.createdAt - a.createdAt);
        let filtered = arr;
        if(q) filtered = arr.filter(p => (p.poNumber||'').toLowerCase().includes(q) || (p.customer||'').toLowerCase().includes(q));
        let html = `<div style="overflow:auto"><table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f6fbff;color:var(--accent-2)"><th style="padding:10px">PO#</th><th>Customer</th><th>Date</th><th>Total</th><th style="width:220px">Actions</th></tr></thead><tbody>`;
        html += filtered.map(p => `<tr><td style="padding:10px">${p.poNumber}</td><td>${escapeHTML(p.customer)}</td><td>${escapeHTML(p.date)}</td><td>‚Ç±${(p.total||0).toFixed(2)}</td><td><button class="btn btn-ghost" onclick='viewPODetail(${JSON.stringify(p).replace(/'/g,"\\'")})'>View</button> <button class="btn btn-ghost" onclick="confirmDeletePO('${p.id}','${escapeHTML(p.poNumber)}')">Delete</button></td></tr>`).join('');
        html += `</tbody></table></div>`;
        container.innerHTML = html;
      }).catch(err => { console.error(err); container.innerHTML = '<div class="muted">Error loading history</div>'; });
    }

    function confirmDeletePO(id, poNumber){
      if(!confirm(`Delete ${poNumber}? This will permanently remove the record.`)) return;
      deletePO(id);
    }

    function deletePO(id){
      // NOTE: as requested, deleting a PO does NOT restore stock quantities
      posRef.child(id).remove().then(()=>{
        showToast('PO deleted');
        renderPOHistory();
        renderPOList();
        refreshSummary();
      }).catch(err=>{
        console.error(err);
        showToast('Error deleting PO');
      });
    }

    /* ---------- PO Viewer ---------- */
    function viewPODetail(p){
      lastViewedPO = p;
      const totalText = `‚Ç±${((p.total||0)).toFixed(2)}`;
      let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHTML(p.poNumber||'')}</strong> ‚Äî ${escapeHTML(p.customer||'')}</div><div>${escapeHTML(p.date||'')}</div></div>`;
      if(p.remarks) html += `<div style="margin-top:8px;color:#566b80">${escapeHTML(p.remarks||'')}</div>`;
      html += `<table style="width:100%;border-collapse:collapse;margin-top:12px"><thead><tr style="background:#f6f8fb"><th style="padding:8px">Item</th><th style="padding:8px;text-align:right">Qty</th><th style="padding:8px">Unit</th><th style="padding:8px;text-align:right">Price</th><th style="padding:8px;text-align:right">Subtotal</th></tr></thead><tbody>`;
      html += (p.lines||[]).map(l=>`<tr><td style="padding:6px">${escapeHTML(l.itemName)}</td><td style="padding:6px;text-align:right">${l.qty}</td><td style="padding:6px">${escapeHTML(l.unit||'')}</td><td style="padding:6px;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td><td style="padding:6px;text-align:right">‚Ç±${((l.qty||0)*(l.price||0)).toFixed(2)}</td></tr>`).join('');
      html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ${totalText}</div>`;
      document.getElementById('poViewerContent').innerHTML = html;
      showModalById('poViewerModal');
    }

    function closePOViewer(){ hideModalById('poViewerModal'); }
    function printLastViewedPO(){ if(!lastViewedPO){ showToast('No PO selected'); return; } openPrintableInvoice(lastViewedPO); }

    /* ---------- Printable invoice ---------- */
    function openPrintableInvoice(p){
      const w = window.open('', '_blank');
      const dateText = p.date || new Date(p.createdAt||Date.now()).toISOString().slice(0,10);
      const rows = (p.lines||[]).map(l=>`<tr><td style="padding:8px;border:1px solid #ddd">${escapeHTML(l.itemName)}</td><td style="padding:8px;border:1px solid #ddd;text-align:right">${l.qty}</td><td style="padding:8px;border:1px solid #ddd">${escapeHTML(l.unit||'')}</td><td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${(l.price||0).toFixed(2)}</td><td style="padding:8px;border:1px solid #ddd;text-align:right">‚Ç±${((l.qty||0)*(l.price||0)).toFixed(2)}</td></tr>`).join('');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>${p.poNumber}</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222}table{width:100%;border-collapse:collapse;margin-top:14px}th{background:#f6f6f6;padding:8px;border:1px solid #ddd;text-align:left}td{padding:8px;border:1px solid #ddd}</style></head><body><div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">MSITE Enterprises</h2><div>Purchase Order</div></div><div style="text-align:right"><div><strong>PO#:</strong> ${p.poNumber}</div><div><strong>Date:</strong> ${dateText}</div><div><strong>Customer:</strong> ${escapeHTML(p.customer)}</div></div></div><table><thead><tr><th>Item</th><th style="text-align:right">Qty</th><th>Unit</th><th style="text-align:right">Price</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>${rows}</tbody></table><div style="text-align:right;margin-top:12px;font-weight:800">Total: ‚Ç±${(p.total||0).toFixed(2)}</div><div style="margin-top:18px;color:#666;font-size:0.9rem">Printed: ${new Date().toLocaleString()}</div></body></html>`;
      w.document.write(html); w.document.close(); w.focus(); setTimeout(()=> w.print(),300);
    }

    function openPrintableInvoiceFromForm(){
      const p = { poNumber: document.getElementById('poNumber').value, customer: document.getElementById('poCustomer').value, date: document.getElementById('poDate').value, lines: JSON.parse(JSON.stringify(window.poLines || [])), total: calcPOTotal(), createdAt: Date.now() };
      openPrintableInvoice(p);
    }

    /* ---------- Print stock ---------- */
    function printStockList(){ const printWindow = window.open('', '_blank'); const tableHTML = `<table style="width:100%;border-collapse:collapse;margin-top:14px"><thead><tr style="background:#0b6ff2;color:white"><th style="padding:8px;border:1px solid #ccc;text-align:left">Item</th><th style="padding:8px;border:1px solid #ccc;text-align:right">Quantity</th><th style="padding:8px;border:1px solid #ccc;text-align:left">Unit</th><th style="padding:8px;border:1px solid #ccc;text-align:right">Price</th></tr></thead><tbody>${(window.stockData||[]).map(s=>`<tr><td style="padding:8px;border:1px solid #ccc">${escapeHTML(s.name)}</td><td style="padding:8px;border:1px solid #ccc;text-align:right">${s.qty}</td><td style="padding:8px;border:1px solid #ccc">${escapeHTML(s.unit||'')}</td><td style="padding:8px;border:1px solid #ccc;text-align:right">‚Ç±${(parseFloat(s.price)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table>`; printWindow.document.write(`<html><head><title>Stock List</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222;}h2{margin:0;text-align:center;color:#0b6ff2;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;text-align:left;}th{background:#0b6ff2;color:#fff;}tr:nth-child(even){background:#f8faff;}</style></head><body><h2>MSITE Stock List</h2><div style="text-align:center;font-size:0.9rem;color:#555;">Printed: ${new Date().toLocaleString()}</div>${tableHTML}</body></html>`); printWindow.document.close(); setTimeout(()=> printWindow.print(),300); }

    /* ---------- Summary ---------- */
    function refreshSummary(){ document.getElementById('summary-count').textContent = (window.stockData||[]).filter(Boolean).length; document.getElementById('summary-total').textContent = (window.stockData||[]).reduce((s,i)=> s + (parseFloat(i.qty)||0), 0); posRef.once('value').then(snap=>{ const val = snap.val(); document.getElementById('summary-pos').textContent = val ? Object.keys(val).length : 0; }).catch(()=>{}); }

    /* ---------- Charts (safe) ---------- */
    function renderDashboardCharts(){ posRef.once('value').then(snap=>{ const data = snap.val(); if(!data){ if(schoolChart){ try{schoolChart.destroy()}catch(e){}; schoolChart=null;} if(itemChart){ try{itemChart.destroy()}catch(e){}; itemChart=null;} return; } const poArr = Object.values(data||{}); const schoolTotals={}; poArr.forEach(po=>{ if(!po.customer) return; schoolTotals[po.customer] = (schoolTotals[po.customer] || 0) + (po.total || 0); }); const top5Schools = Object.entries(schoolTotals).sort((a,b)=>b[1]-a[1]).slice(0,5); const itemTotals={}; poArr.forEach(po=>{ (po.lines||[]).forEach(line=>{ if(!line.itemName) return; itemTotals[line.itemName] = (itemTotals[line.itemName] || 0) + (parseFloat(line.qty) || 0); }); }); const top5Items = Object.entries(itemTotals).sort((a,b)=>b[1]-a[1]).slice(0,5); const schoolsLabels = top5Schools.map(x=>x[0]); const schoolsData = top5Schools.map(x=>x[1]); const ctxS = document.getElementById('topSchoolsChart').getContext('2d'); if(schoolChart){ try{ schoolChart.destroy(); }catch(e){} } schoolChart = new Chart(ctxS,{ type:'bar', data:{ labels: schoolsLabels, datasets:[{ label:'Total (‚Ç±)', data: schoolsData }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); const itemsLabels = top5Items.map(x=>x[0]); const itemsData = top5Items.map(x=>x[1]); const ctxI = document.getElementById('bestItemsChart').getContext('2d'); if(itemChart){ try{ itemChart.destroy(); }catch(e){} } itemChart = new Chart(ctxI,{ type:'bar', data:{ labels: itemsLabels, datasets:[{ label:'Qty Sold', data: itemsData }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); }).catch(err=>console.error('Chart update error',err)); }
    function scheduleChartUpdate(){ if(chartUpdateTimer) clearTimeout(chartUpdateTimer); chartUpdateTimer = setTimeout(()=>{ renderDashboardCharts(); chartUpdateTimer = null; }, 500); }

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      openMenu('dashboard');
      renderStock();
      initPOForm();
      renderPOList();
      renderPOHistory();
      refreshSummary();

      // register one posRef listener to update lists & schedule charts
      posRef.on('value', ()=>{
        renderPOList();
        renderPOHistory();
        refreshSummary();
        scheduleChartUpdate();
      });

      renderDashboardCharts();

      document.getElementById('hamburger').addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('show'));
    });

    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> { navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW registered',reg)).catch(e=>console.warn('SW failed', e)); }); }

    function resetPOForm(){ if(!confirm('Reset PO form?')) return; initPOForm(); }

    function toggleSidebar() {
  const sidebar = document.querySelector('aside.sidebar');
  sidebar.classList.toggle('show');
}
document.querySelectorAll('.nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    const sidebar = document.querySelector('aside.sidebar');
    sidebar.classList.remove('show');
  });
});

  </script>
</body>
</html>
